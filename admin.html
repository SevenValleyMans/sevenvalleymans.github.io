<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ë¡œë˜1081 ê´€ë¦¬ì</title>
   <link rel="icon" href="https://lotto1081.com/allFile/logo.jpg" type="image">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBH3AvpxtOF7NQDH_fDOuAXSyEfw8r5kbU",
      authDomain: "lotto1081-2b3dc.firebaseapp.com",
      projectId: "lotto1081-2b3dc",
      storageBucket: "lotto1081-2b3dc.appspot.com",
      messagingSenderId: "785261698548",
      appId: "1:785261698548:web:84531550d2380c24f82da1",
    };
    firebase.initializeApp(firebaseConfig);
  </script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#8B0000',
            secondary: '#D4AF37',
            accent: '#64748B',
            light: '#F8FAFC',
          },
          fontFamily: {
            sans: ['Noto Sans KR', 'sans-serif'],
          },
          backgroundImage: {
            'gradient-radial': 'radial-gradient(var(--tw-gradient-stops))',
            'hero-pattern': "url('data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%238B0000' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E')",
          },
        },
      },
    }
  </script>
  <style>
    body { font-family: 'Noto Sans KR', sans-serif; }
    .section-card { background: #fff; border-radius: 1rem; box-shadow: 0 4px 24px rgba(30,58,138,0.07);}
    .table thead { background: #F8FAFC; }
    .tab-active { color: #8B0000; border-bottom: 2px solid #8B0000; }
  </style>
</head>
<body class="bg-light min-h-screen">
  <nav class="fixed w-full bg-white/90 shadow-sm z-50 border-b border-accent/20">
    <div class="container mx-auto px-4 flex items-center justify-between h-16">
      <span class="text-2xl font-bold text-primary">ë¡œë˜1081 ê´€ë¦¬ì</span>
    </div>
  </nav>
  <div class="h-16"></div>

  <main class="container mx-auto px-4 max-w-4xl pt-8 pb-10">

      <!-- ê¸ˆì£¼ ë‹¹ì²¨ë²ˆí˜¸ ì…ë ¥ ì„¹ì…˜ -->
<section id="winningSection" class="section-card p-6 border border-accent/20 mb-6">
  <h2 class="text-xl font-bold text-primary mb-3">ê¸ˆì£¼ ë‹¹ì²¨ë²ˆí˜¸ ì…ë ¥</h2>
  <form id="winningForm" class="flex gap-2 mb-2 flex-wrap">
    <input type="number" min="1" max="45" required class="w-14 p-2 border rounded" placeholder="1ë²ˆ" id="win1">
    <input type="number" min="1" max="45" required class="w-14 p-2 border rounded" placeholder="2ë²ˆ" id="win2">
    <input type="number" min="1" max="45" required class="w-14 p-2 border rounded" placeholder="3ë²ˆ" id="win3">
    <input type="number" min="1" max="45" required class="w-14 p-2 border rounded" placeholder="4ë²ˆ" id="win4">
    <input type="number" min="1" max="45" required class="w-14 p-2 border rounded" placeholder="5ë²ˆ" id="win5">
    <input type="number" min="1" max="45" required class="w-14 p-2 border rounded" placeholder="6ë²ˆ" id="win6">
    <input type="number" min="1" max="45" class="w-14 p-2 border rounded" placeholder="ë³´ë„ˆìŠ¤" id="winBonus">
    <button type="submit" class="px-4 py-2 bg-primary text-white rounded font-bold ml-2">ì €ì¥</button>
  </form>
  <div id="winningLatest" class="text-gray-600 text-sm"></div>
  <!-- ìœ ì €ë³„ ì„±ì  í‘œì‹œ -->
  <div id="userResults" class="mt-6"></div>
</section>
    <!-- íƒ­ ë©”ë‰´ -->
    <div class="flex border-b mb-6">
      <button id="tab-users" class="px-4 py-2 font-bold tab-active">íšŒì›ê´€ë¦¬</button>
      <button id="tab-qna" class="px-4 py-2 font-bold text-gray-500">Q&A ê´€ë¦¬</button>
    </div>

    <!-- íšŒì›ê´€ë¦¬ -->
    <section id="userSection" class="section-card p-6 border border-accent/20">
      <h2 class="text-xl font-bold text-primary mb-3">íšŒì› ëª©ë¡</h2>
      <div id="userList" class="overflow-x-auto">
        <table class="table w-full text-center text-gray-700">
          <thead>
            <tr>
              <th class="py-2 px-3">ì´ë©”ì¼</th>
              <th class="py-2 px-3">ë‹‰ë„¤ì„</th>
              <th class="py-2 px-3">ê°€ì…ì¼</th>
              <th class="py-2 px-3">ë²ˆí˜¸ ë°œì†¡</th>
            </tr>
          </thead>
          <tbody>
            <!-- íšŒì› ë¦¬ìŠ¤íŠ¸ JSë¡œ ë¡œë“œ -->
          </tbody>
        </table>
      </div>
    </section>

    <!-- QnA ê´€ë¦¬ (ë‹µë³€ ëª¨ë‹¬ í¬í•¨) -->
    <section id="qnaSection" class="section-card p-6 border border-accent/20 hidden">
      <h2 class="text-xl font-bold text-primary mb-3">Q&A ì „ì²´ ëª©ë¡</h2>
      <div id="qnaList" class="overflow-x-auto"></div>
    </section>

    <!-- ë‹µë³€ ëª¨ë‹¬ -->
    <div id="answerModal" class="fixed inset-0 bg-black/40 flex items-center justify-center z-50 hidden">
      <div class="bg-white rounded-xl shadow-xl p-8 max-w-md w-full relative">
        <button id="closeAnswerModal" class="absolute top-2 right-2 text-gray-400 hover:text-primary text-2xl">&times;</button>
        <h3 class="text-lg font-bold text-primary mb-4">Q&A ë‹µë³€ ì‘ì„±</h3>
        <div class="mb-2 font-semibold" id="modalQTitle"></div>
        <div class="mb-4 text-gray-600" id="modalQContent"></div>
        <form id="answerForm" class="space-y-3">
          <textarea id="answerInput" class="w-full border rounded p-2" rows="4" placeholder="ë‹µë³€ì„ ì…ë ¥í•˜ì„¸ìš”" required></textarea>
          <button type="submit" class="px-4 py-2 bg-primary text-white rounded font-bold">ì €ì¥</button>
        </form>
      </div>
    </div>

<!-- ì¶”ì²œë²ˆí˜¸ ë°œì†¡ ëª¨ë‹¬ -->
<div id="sendModal" class="fixed inset-0 bg-black/40 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-xl shadow-xl p-8 max-w-md w-full">
    <h3 class="text-lg font-bold text-primary mb-4">ì¶”ì²œë²ˆí˜¸ ë°œì†¡</h3>
    <div class="mb-2 text-gray-700" id="currentRoundInfo"></div>
    <form id="sendForm" class="space-y-3">
      <input type="hidden" id="sendEmail" />
      <div>
        <label class="block font-semibold mb-1">ì¶”ì²œë²ˆí˜¸</label>
        <input type="text" id="sendNumbers" class="w-full p-2 border rounded" placeholder="ì˜ˆ: 1, 3, 14, 26, 30, 44" required>
      </div>
      <div>
        <label class="block font-semibold mb-1">ì‘ì› ë©”ì‹œì§€</label>
        <select id="cheerSelect" class="w-full p-2 border rounded mb-1">
          <option value="ì´ë²ˆ ì£¼ì—ëŠ” í–‰ìš´ì´ í•¨ê»˜ í•˜ì‹œê¸¸!">ì´ë²ˆ ì£¼ì—ëŠ” í–‰ìš´ì´ í•¨ê»˜ í•˜ì‹œê¸¸!</option>
          <option value="ê¿ˆì€ ì´ë£¨ì–´ì§‘ë‹ˆë‹¤!">ê¿ˆì€ ì´ë£¨ì–´ì§‘ë‹ˆë‹¤!</option>
          <option value="ë§¤ì£¼ í–‰ë³µí•œ í•œ ì£¼ ë³´ë‚´ì„¸ìš”!">ë§¤ì£¼ í–‰ë³µí•œ í•œ ì£¼ ë³´ë‚´ì„¸ìš”!</option>
          <option value="ë¡œë˜1081ì´ ëŠ˜ ì‘ì›í•©ë‹ˆë‹¤!">ë¡œë˜1081ì´ ëŠ˜ ì‘ì›í•©ë‹ˆë‹¤!</option>
        </select>
        <input type="text" id="customCheer" class="w-full p-2 border rounded mt-1" placeholder="ì§ì ‘ ì…ë ¥ (ì„ íƒ)" />
        <small class="text-gray-400">ì§ì ‘ ì…ë ¥í•˜ë©´ ì„ íƒ ë©”ì‹œì§€ ëŒ€ì‹  ì‚¬ìš©ë©ë‹ˆë‹¤.</small>
      </div>
      <div class="flex gap-2">
        <button type="button" id="autoNumber" class="px-3 py-1 bg-accent text-white rounded">ìë™ì¶”ì²œ</button>
        <button type="submit" class="px-4 py-1 bg-primary text-white rounded font-bold">ë°œì†¡</button>
        <button type="button" id="closeSendModal" class="ml-auto px-4 py-1 bg-gray-200 rounded">ì·¨ì†Œ</button>
      </div>
    </form>
  </div>
</div>


    <!-- íšŒì›ë³„ ì¶”ì²œë²ˆí˜¸ ì´ë ¥ ëª¨ë‹¬ -->
    <div id="historyModal" class="fixed inset-0 bg-black/40 flex items-center justify-center z-50 hidden">
      <div class="bg-white rounded-xl shadow-xl p-8 max-w-md w-full relative">
        <button id="closeHistoryModal" class="absolute top-2 right-2 text-gray-400 hover:text-primary text-2xl">&times;</button>
        <h3 class="text-lg font-bold text-primary mb-4">íšŒì°¨ë³„ ì¶”ì²œë²ˆí˜¸ ì´ë ¥</h3>
        <div id="historyContent"></div>
      </div>
    </div>

  </main>





<div id="pwCover" style="position:fixed;z-index:9999;top:0;left:0;width:100vw;height:100vh;background:#fff;display:flex;align-items:center;justify-content:center;">
  <div>
    <input id="adminPw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" />
    <button onclick="checkPw()">í™•ì¸</button>
  </div>
</div>

  <script>
    // 1. íšŒì°¨ ìë™ê³„ì‚° í•¨ìˆ˜ (2025-06-21 = 1177íšŒì°¨)
    function getCurrentRound(today = new Date()) {
      const baseRound = 1177;
      const baseDate = new Date(2025, 5, 21); // 2025-06-21 (month 0-indexed)
      const diffMs = today - baseDate;
      const diffWeeks = Math.floor(diffMs / (1000 * 60 * 60 * 24 * 7));
      return baseRound + diffWeeks;
    }

    // 2. íƒ­ ì „í™˜
    document.getElementById('tab-users').onclick = function() {
      document.getElementById('userSection').classList.remove('hidden');
      document.getElementById('qnaSection').classList.add('hidden');
      this.classList.add('tab-active');
      document.getElementById('tab-qna').classList.remove('tab-active');
    };
    document.getElementById('tab-qna').onclick = function() {
      document.getElementById('userSection').classList.add('hidden');
      document.getElementById('qnaSection').classList.remove('hidden');
      this.classList.add('tab-active');
      document.getElementById('tab-users').classList.remove('tab-active');
      loadQnaList();
    };

    // 3. íšŒì› ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° + ì´ë©”ì¼ í´ë¦­ì‹œ ì´ë ¥ í™•ì¸
    function loadUsers() {
      const tbody = document.querySelector('#userList tbody');
      tbody.innerHTML = '';
      firebase.firestore().collection('users').get().then(snapshot => {
        snapshot.forEach(doc => {
          const user = doc.data();
          const userId = user.userId || '-';
          const nickname = user.name || '-';
          const created = user.createdAt && user.createdAt.toDate ? user.createdAt.toDate().toLocaleDateString() : '-';
          tbody.innerHTML += `
            <tr>
              <td class="py-2 px-3 email-cell cursor-pointer text-blue-700 hover:underline">${userId}</td>
              <td class="py-2 px-3">${nickname}</td>
              <td class="py-2 px-3">${created}</td>
              <td class="py-2 px-3">
                <button class="sendBtn px-3 py-1 bg-primary text-white rounded" data-email="${userId}">ë°œì†¡</button>
              </td>
            </tr>
          `;
        });
        document.querySelectorAll('.sendBtn').forEach(btn => {
          btn.onclick = () => openSendModal(btn.getAttribute('data-email'));
        });
        document.querySelectorAll('.email-cell').forEach(td => {
          td.onclick = () => openHistoryModal(td.textContent);
        });
      });
    }

    // 4. ì¶”ì²œë²ˆí˜¸ ë°œì†¡ ëª¨ë‹¬ ì—´ê¸° (íšŒì°¨ ì•ˆë‚´ í¬í•¨)
    function openSendModal(userId) {
      document.getElementById('sendEmail').value = userId;
      document.getElementById('sendNumbers').value = '';
      // íšŒì°¨ ì •ë³´ ì•ˆë‚´
      const round = getCurrentRound();
      const today = new Date();
      const weekEnd = new Date(today.getFullYear(), today.getMonth(), today.getDate() + (6 - today.getDay())); // í† ìš”ì¼(6)ê¹Œì§€ ë‚¨ì€ ë‚ 
      document.getElementById('currentRoundInfo').innerHTML = `<span class="text-primary font-bold">${round}íšŒì°¨</span> (${weekEnd.getFullYear()}-${String(weekEnd.getMonth()+1).padStart(2,'0')}-${String(weekEnd.getDate()).padStart(2,'0')}) ì¶”ì²¨ë¶„`;
      document.getElementById('sendModal').classList.remove('hidden');
    }
    document.getElementById('closeSendModal').onclick = () => {
      document.getElementById('sendModal').classList.add('hidden');
    };

    // 5. ìë™ ì¶”ì²œë²ˆí˜¸(ëœë¤)
    document.getElementById('autoNumber').onclick = function(e) {
      e.preventDefault();
      const nums = [];
      while (nums.length < 6) {
        const n = Math.floor(Math.random() * 45) + 1;
        if (!nums.includes(n)) nums.push(n);
      }
      nums.sort((a, b) => a - b);
      document.getElementById('sendNumbers').value = nums.join(', ');
    };

    // 6. ì¶”ì²œë²ˆí˜¸ ë°œì†¡(íŒŒì´ì–´ìŠ¤í† ì–´ì— íšŒì°¨ê¹Œì§€ ê¸°ë¡)

    // 7. íšŒì› ì´ë ¥ ëª¨ë‹¬ ì—´ê¸° (íšŒì°¨ë³„ ì¶”ì²œë²ˆí˜¸ ë³´ê¸°)
function openHistoryModal(userId) {
  const modal = document.getElementById('historyModal');
  const contentDiv = document.getElementById('historyContent');
  contentDiv.innerHTML = '<div class="text-gray-500 text-center py-4">ë¡œë”© ì¤‘...</div>';
  modal.classList.remove('hidden');

  firebase.firestore().collection('recommendations')
    .where('userId', '==', userId)
    .orderBy('sentAt', 'desc') // â† ì—¬ê¸°ë§Œ ë°”ê¿”ì£¼ë©´ ë¨
    .get()
    .then(snapshot => {
      if (snapshot.empty) {
        contentDiv.innerHTML = '<div class="text-gray-500 text-center py-4">ì¶”ì²œë²ˆí˜¸ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }
      let html = `<table class="w-full text-center border mt-2">
        <thead>
          <tr class="bg-gray-50">
            <th class="py-1 px-2">íšŒì°¨</th>
            <th class="py-1 px-2">ì¶”ì²œë²ˆí˜¸</th>
            <th class="py-1 px-2">ë°œì†¡ì¼</th>
          </tr>
        </thead>
        <tbody>`;
      snapshot.forEach(doc => {
        const data = doc.data();
        const dt = data.sentAt && data.sentAt.toDate ? data.sentAt.toDate().toLocaleDateString() : '';
        html += `<tr>
          <td class="py-1 px-2 font-bold">${data.round || '-'}</td>
          <td class="py-1 px-2">${data.numbers}</td>
          <td class="py-1 px-2">${dt}</td>
        </tr>`;
      });
      html += '</tbody></table>';
      contentDiv.innerHTML = html;
    });
}


    document.getElementById('closeHistoryModal').onclick = () => {
      document.getElementById('historyModal').classList.add('hidden');
    };

    // 8. QnA ì „ì²´ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° (ê¸°ì¡´ ì½”ë“œ ìœ ì§€)
    function loadQnaList() {
      const div = document.getElementById('qnaList');
      div.innerHTML = '';
      firebase.firestore().collection('qna').orderBy('createdAt', 'desc').get().then(snapshot => {
        if (snapshot.empty) {
          div.innerHTML = '<p class="py-6 text-accent text-center">Q&Aê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
          return;
        }
        div.innerHTML = `<table class="table w-full text-center text-gray-700">
          <thead>
            <tr>
              <th class="py-2 px-3">ì œëª©</th>
              <th class="py-2 px-3">ì´ë©”ì¼</th>
              <th class="py-2 px-3">ì‘ì„±ì¼</th>
              <th class="py-2 px-3">ë‹µë³€ìƒíƒœ</th>
              <th class="py-2 px-3">ê´€ë¦¬</th>
            </tr>
          </thead>
          <tbody>
            ${snapshot.docs.map(doc => {
              const q = doc.data();
              const date = q.createdAt && q.createdAt.toDate ? q.createdAt.toDate().toLocaleDateString() : '';
              return `
                <tr>
                  <td class="py-2 px-3 text-left">${q.title}</td>
                  <td class="py-2 px-3">${q.email || ''}</td>
                  <td class="py-2 px-3">${date}</td>
                  <td class="py-2 px-3">
                    ${q.answer && q.answer.trim() ? '<span class="status-paid">ì™„ë£Œ</span>' : '<span class="status-expired">ëŒ€ê¸°</span>'}
                  </td>
                  <td class="py-2 px-3">
                    <button class="answerBtn bg-accent text-white rounded px-3 py-1" 
                      data-id="${doc.id}" 
                      data-title="${q.title}" 
                      data-content="${q.content}" 
                      data-answer="${q.answer || ''}">
                      ${q.answer && q.answer.trim() ? 'ìˆ˜ì •' : 'ë‹µë³€'}
                    </button>
                  </td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>`;
        document.querySelectorAll('.answerBtn').forEach(btn => {
          btn.onclick = function() {
            openAnswerModal(
              this.getAttribute('data-id'),
              this.getAttribute('data-title'),
              this.getAttribute('data-content'),
              this.getAttribute('data-answer')
            );
          };
        });
      });
    }

    // QnA ë‹µë³€ ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸°
    function openAnswerModal(id, title, content, answer) {
      document.getElementById('answerModal').classList.remove('hidden');
      document.getElementById('modalQTitle').textContent = title;
      document.getElementById('modalQContent').textContent = content;
      document.getElementById('answerInput').value = answer || '';
      document.getElementById('answerForm').onsubmit = function(e) {
        e.preventDefault();
        const val = document.getElementById('answerInput').value.trim();
        firebase.firestore().collection('qna').doc(id).update({ answer: val })
          .then(() => {
            document.getElementById('answerModal').classList.add('hidden');
            loadQnaList();
          });
      };
    }
    document.getElementById('closeAnswerModal').onclick = () => {
      document.getElementById('answerModal').classList.add('hidden');
    };

    // ì²« ì§„ì…ì‹œ íšŒì› ëª©ë¡ ë¡œë“œ
    loadUsers();
document.getElementById('sendForm').onsubmit = async function(e) {
  e.preventDefault();
  const userId = document.getElementById('sendEmail').value;
  const numbers = document.getElementById('sendNumbers').value;
  const round = getCurrentRound();
  const now = new Date();
  const selectMsg = document.getElementById('cheerSelect').value;
  const customMsg = document.getElementById('customCheer').value.trim();
  // ì§ì ‘ ì…ë ¥ì´ ìˆìœ¼ë©´ custom, ì•„ë‹ˆë©´ select ê°’
  const cheerMsg = customMsg ? customMsg : selectMsg;

  // 1. íŒŒì´ì–´ìŠ¤í† ì–´ ì €ì¥
  await firebase.firestore().collection('recommendations').add({
    userId,
    numbers,
    round,
    sentAt: now,
    cheerMsg  // ì¶”ê°€ë¡œ ì‘ì› ë©”ì‹œì§€ë„ ì €ì¥í•˜ë©´ ì¢‹ìŒ
  });

  // 2. ì‚¬ìš©ì ì „í™”ë²ˆí˜¸ ì°¾ê¸°
  let phone = '';
  const userDoc = await firebase.firestore().collection('users').where('userId', '==', userId).get();
  if (!userDoc.empty) {
    phone = userDoc.docs[0].data().phone;
  }
  if (phone) {
    fetch('http://localhost:4000/send-sms', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        to: phone,
        numbers: numbers,
        message: cheerMsg   // â† ë©”ì‹œì§€ë„ í•¨ê»˜ ì „ì†¡
      })
    })
      .then(r => r.json())
      .then(result => {
        if (result.success) {
          alert('ì¶”ì²œë²ˆí˜¸ê°€ ì €ì¥ë˜ê³  ë¬¸ìë¡œë„ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
        } else {
          alert('ë¬¸ì ë°œì†¡ ì‹¤íŒ¨: ' + JSON.stringify(result.error));
        }
      })
      .catch(err => alert('ë¬¸ì ë°œì†¡ ì—ëŸ¬: ' + err));
  } else {
    alert('ì‚¬ìš©ì ì „í™”ë²ˆí˜¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. Firestoreì— ì „í™”ë²ˆí˜¸ë¥¼ ì¶”ê°€í•´ ì£¼ì„¸ìš”.');
  }

  document.getElementById('sendModal').classList.add('hidden');
};


//ì—¬ê¸°ì„œë¶€í„° ì•„ë˜ëŠ” ê¸ˆì£¼ì˜ ë‹¹ì²¨ë²ˆí˜¸

// ê¸ˆì£¼ ë‹¹ì²¨ë²ˆí˜¸ ì…ë ¥ ë° Firestore ì €ì¥
document.getElementById('winningForm').onsubmit = async function(e) {
  e.preventDefault();
  const round = getCurrentRound();
  const numbers = [
    Number(document.getElementById('win1').value),
    Number(document.getElementById('win2').value),
    Number(document.getElementById('win3').value),
    Number(document.getElementById('win4').value),
    Number(document.getElementById('win5').value),
    Number(document.getElementById('win6').value)
  ];
  const bonus = Number(document.getElementById('winBonus').value) || null;

  // ì¤‘ë³µ/ë²”ìœ„ ì²´í¬
  if (new Set(numbers).size !== 6 || numbers.some(n => n < 1 || n > 45)) {
    alert('1~45 ì‚¬ì´ì˜ ì¤‘ë³µ ì—†ëŠ” 6ê°œ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
    return;
  }
  if (bonus && (numbers.includes(bonus) || bonus < 1 || bonus > 45)) {
    alert('ë³´ë„ˆìŠ¤ ë²ˆí˜¸ëŠ” 1~45 ì‚¬ì´, ê¸°ì¡´ 6ê°œì™€ ê²¹ì¹˜ë©´ ì•ˆë©ë‹ˆë‹¤.');
    return;
  }

  await firebase.firestore().collection('winningNumbers').add({
    round,
    numbers,
    bonus,
    createdAt: new Date()
  });
  alert('ê¸ˆì£¼ ë‹¹ì²¨ë²ˆí˜¸ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
  loadLatestWinningNumber(); // ìµœì‹  ë‹¹ì²¨ë²ˆí˜¸ ë‹¤ì‹œ ë¡œë“œ
};

// ìµœì‹  ë‹¹ì²¨ë²ˆí˜¸ ë³´ì—¬ì£¼ê¸°
async function loadLatestWinningNumber() {
  const div = document.getElementById('winningLatest');
  div.textContent = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
  const round = Number(getCurrentRound());
  const q = await firebase.firestore()
    .collection('winningNumbers')
    .where('round', '==', round)
    .orderBy('createdAt', 'desc')
    .limit(1)
    .get();
  if (q.empty) {
    div.textContent = `ì´ë²ˆì£¼(${round}íšŒì°¨) ë‹¹ì²¨ë²ˆí˜¸ê°€ ì…ë ¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.`;
  } else {
    const data = q.docs[0].data();
    div.innerHTML = `<b>${data.round}íšŒì°¨</b> | ${data.numbers.join(', ')}${data.bonus ? ' + ë³´ë„ˆìŠ¤: ' + data.bonus : ''}`;
    // ì…ë ¥í¼ì—ë„ ë¶ˆëŸ¬ì˜¤ê¸°
    data.numbers.forEach((num, idx) => {
      document.getElementById('win' + (idx+1)).value = num;
    });
    if (data.bonus) document.getElementById('winBonus').value = data.bonus;
  }
}


// ì§„ì…ì‹œ ìµœì‹  ë‹¹ì²¨ë²ˆí˜¸ë„ ê°™ì´ ë¡œë“œ
loadLatestWinningNumber();


// ì—¬ê¸°ì„œë¶€í„° ìœ ì € ì„±ì  í™•ì¸
async function checkUserResult(userId) {
  const round = Number(getCurrentRound());
  // ì¶”ì²œë²ˆí˜¸ ë¶ˆëŸ¬ì˜¤ê¸°
  const recSnap = await firebase.firestore()
    .collection('recommendations')
    .where('userId', '==', userId)
    .where('round', '==', round)
    .limit(1)
    .get();
  if (recSnap.empty) return { error: "ì¶”ì²œë²ˆí˜¸ ê¸°ë¡ ì—†ìŒ" };
  const recData = recSnap.docs[0].data();
  const userNums = recData.numbers
    .split(',')
    .map(s => Number(s.trim()))
    .filter(n => !isNaN(n));

  // ë‹¹ì²¨ë²ˆí˜¸ ë¶ˆëŸ¬ì˜¤ê¸°
  const winSnap = await firebase.firestore()
    .collection('winningNumbers')
    .where('round', '==', round)
    .orderBy('createdAt', 'desc')
    .limit(1)
    .get();
  if (winSnap.empty) return { error: "í•´ë‹¹ íšŒì°¨ ë‹¹ì²¨ë²ˆí˜¸ ì—†ìŒ" };
  const winData = winSnap.docs[0].data();
  const winNums = winData.numbers.map(n => Number(n));
  const bonus = Number(winData.bonus);

  // ì¼ì¹˜ ê³„ì‚°
  const match = userNums.filter(n => winNums.includes(n));
  const matchCount = match.length;
  const bonusMatch = bonus && userNums.includes(bonus);

  return {
    userId,
    round,
    userNums,
    winNums,
    match,
    matchCount,
    bonus,
    bonusMatch
  };
}


//ì—¬ê¸°ì„œë¶€í„° ë¶ˆëŸ¬ì˜¤ê¸°
async function loadUserResults() {
  const div = document.getElementById('userResults');
  div.innerHTML = '<div class="text-gray-500">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
  const round = Number(getCurrentRound());

  const [usersSnap, winSnap, recsSnap] = await Promise.all([
    firebase.firestore().collection('users').get(),
    firebase.firestore().collection('winningNumbers').where('round', '==', round).orderBy('createdAt', 'desc').limit(1).get(),
    firebase.firestore().collection('recommendations').where('round', '==', round).get(),
  ]);

  if (usersSnap.empty) {
    div.innerHTML = '<div class="text-gray-500">ê°€ì…í•œ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
    return;
  }
  if (winSnap.empty) {
    div.innerHTML = '<div class="text-gray-500">ì´ë²ˆ íšŒì°¨ ë‹¹ì²¨ë²ˆí˜¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
    return;
  }

  const winData = winSnap.docs[0].data();
  const winNums = winData.numbers.map(Number);
  const bonus = Number(winData.bonus);
  
  // map: userId â†’ ì¶”ì²œë²ˆí˜¸
// map: userId â†’ ì¶”ì²œë²ˆí˜¸ ë°°ì—´
const recsMap = {};
recsSnap.forEach(doc => {
  const rec = doc.data();
  // ëª¨ë“  userId, numbers ê°’ì— trim ì ìš©
  const key = (rec.userId || '').trim();
  const nums = (rec.numbers || '').trim();
  if (!recsMap[key]) recsMap[key] = [];
  recsMap[key].push(nums);
});

    let html = `
      <table class="table w-full text-center mt-4">
        <thead>
          <tr>
            <th class="py-2 px-3">ì´ë©”ì¼</th>
            <th class="py-2 px-3">ë‹‰ë„¤ì„</th>
            <th class="py-2 px-3">ì¶”ì²œë²ˆí˜¸</th>
            <th class="py-2 px-3">ì¼ì¹˜</th>
            <th class="py-2 px-3">ë³´ë„ˆìŠ¤</th>
            <th class="py-2 px-3">ë“±ìˆ˜</th>   <!-- ğŸ‘ˆ ì¶”ê°€ -->
          </tr>
        </thead>
        <tbody>
    `;


usersSnap.forEach(doc => {
  const user = doc.data();
  const userId = user.userId;
  const name = user.name || '-';
  const numsArr = recsMap[userId];
   console.log("userId:", userId, "numsArr:", numsArr); // ë””ë²„ê¹… ë¡œê·¸
  if (!numsArr || numsArr.length === 0) {
    html += `<tr>
      <td class="py-1 px-2">${userId}</td>
      <td class="py-1 px-2">${name}</td>
      <td class="py-1 px-2 text-gray-400">-</td>
      <td class="py-1 px-2 text-gray-400">-</td>
      <td class="py-1 px-2 text-gray-400">-</td>
      <td class="py-1 px-2 text-gray-400">-</td>
    </tr>`;
    return;
  }

  // ì—¬ëŸ¬ ì¶”ì²œë²ˆí˜¸ ì¤‘ â€œìµœê³  ë“±ìˆ˜â€ë¡œ ì±„íƒ
  let best = {
    matchCount: 0,
    match: [],
    bonusMatch: false,
    rankValue: 10, // 1ë“±:1, 2ë“±:2... 5ë“±:5, -:10
    rank: "-",
    nums: ""
    
  };
numsArr.forEach(numsStr => {
    const userNums = numsStr.split(',').map(s => Number(s.trim())).filter(n => !isNaN(n));
    console.log("userNums:", userNums, "| winNums:", winNums); // ì—¬ê¸°ê¹Œì§€ë§Œ ë””ë²„ê¹…
    const match = userNums.filter(n => winNums.includes(n));
    const bonusMatch = bonus && userNums.includes(bonus);
    const rank = getLottoRank(match.length, bonusMatch);
    const rankValue = getRankValue(match.length, bonusMatch);
    if (rankValue < best.rankValue) {
      best = {
        matchCount: match.length,
        match,
        bonusMatch,
        rankValue,
        rank,
        nums: userNums.join(', ')
      };
    }
  });

  html += `<tr>
    <td class="py-1 px-2">${userId}</td>
    <td class="py-1 px-2">${name}</td>
    <td class="py-1 px-2">${best.nums}</td>
    <td class="py-1 px-2 font-bold">${best.matchCount}ê°œ (${best.match.join(', ')})</td>
    <td class="py-1 px-2">${best.bonusMatch ? 'O' : 'X'}</td>
    <td class="py-1 px-2 font-bold">${best.rank}</td>
  </tr>`;
});

// ë“±ìˆ˜ì˜ ìˆ«ìê°’ (ë“±ìˆ˜ê°€ ë‚®ì„ìˆ˜ë¡ 1ë“±)
function getRankValue(matchCount, bonusMatch) {
  if (matchCount === 6) return 1;
  if (matchCount === 5 && bonusMatch) return 2;
  if (matchCount === 5) return 3;
  if (matchCount === 4) return 4;
  if (matchCount === 3) return 5;
  return 10; // ë¯¸ë‹¹ì²¨
}



  html += '</tbody></table>';
  div.innerHTML = html;
}

function getLottoRank(matchCount, bonusMatch) {
  if (matchCount === 6) return "1ë“±";
  if (matchCount === 5 && bonusMatch) return "2ë“±";
  if (matchCount === 5) return "3ë“±";
  if (matchCount === 4) return "4ë“±";
  if (matchCount === 3) return "5ë“±";
  return "-";
}



// ì§„ì…ì‹œ ìµœì‹  ë‹¹ì²¨ë²ˆí˜¸ë„ ê°™ì´ ë¡œë“œ
loadLatestWinningNumber();
loadUserResults();

document.getElementById('winningForm').onsubmit = async function(e) {
  e.preventDefault();
  const round = getCurrentRound();
  const numbers = [
    Number(document.getElementById('win1').value),
    Number(document.getElementById('win2').value),
    Number(document.getElementById('win3').value),
    Number(document.getElementById('win4').value),
    Number(document.getElementById('win5').value),
    Number(document.getElementById('win6').value)
  ];
  const bonus = Number(document.getElementById('winBonus').value) || null;

  // ì¤‘ë³µ/ë²”ìœ„ ì²´í¬
  if (new Set(numbers).size !== 6 || numbers.some(n => n < 1 || n > 45)) {
    alert('1~45 ì‚¬ì´ì˜ ì¤‘ë³µ ì—†ëŠ” 6ê°œ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
    return;
  }
  if (bonus && (numbers.includes(bonus) || bonus < 1 || bonus > 45)) {
    alert('ë³´ë„ˆìŠ¤ ë²ˆí˜¸ëŠ” 1~45 ì‚¬ì´, ê¸°ì¡´ 6ê°œì™€ ê²¹ì¹˜ë©´ ì•ˆë©ë‹ˆë‹¤.');
    return;
  }

  await firebase.firestore().collection('winningNumbers').add({
    round,
    numbers,
    bonus,
    createdAt: new Date()
  });
  alert('ê¸ˆì£¼ ë‹¹ì²¨ë²ˆí˜¸ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
  loadLatestWinningNumber();
  loadUserResults();
};





  </script>


<script>
  function checkPw() {
    const pw = document.getElementById('adminPw').value;
    if (pw === '1081') {
      document.getElementById('pwCover').style.display = 'none';
    } else {
      alert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.');
    }
  }
</script>
</body>
</html>