<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>로또1081 관리자</title>
   <link rel="icon" href="https://lotto1081.com/allFile/logo.jpg" type="image">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBH3AvpxtOF7NQDH_fDOuAXSyEfw8r5kbU",
      authDomain: "lotto1081-2b3dc.firebaseapp.com",
      projectId: "lotto1081-2b3dc",
      storageBucket: "lotto1081-2b3dc.appspot.com",
      messagingSenderId: "785261698548",
      appId: "1:785261698548:web:84531550d2380c24f82da1",
    };
    firebase.initializeApp(firebaseConfig);
  </script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#8B0000',
            secondary: '#D4AF37',
            accent: '#64748B',
            light: '#F8FAFC',
          },
          fontFamily: {
            sans: ['Noto Sans KR', 'sans-serif'],
          },
          backgroundImage: {
            'gradient-radial': 'radial-gradient(var(--tw-gradient-stops))',
            'hero-pattern': "url('data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%238B0000' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E')",
          },
        },
      },
    }
  </script>
  <style>
    body { font-family: 'Noto Sans KR', sans-serif; }
    .section-card { background: #fff; border-radius: 1rem; box-shadow: 0 4px 24px rgba(30,58,138,0.07);}
    .table thead { background: #F8FAFC; }
    .tab-active { color: #8B0000; border-bottom: 2px solid #8B0000; }
  </style>
</head>
<body class="bg-light min-h-screen">
  <nav class="fixed w-full bg-white/90 shadow-sm z-50 border-b border-accent/20">
    <div class="container mx-auto px-4 flex items-center justify-between h-16">
      <span class="text-2xl font-bold text-primary">로또1081 관리자</span>
    </div>
  </nav>
  <div class="h-16"></div>

  <main class="container mx-auto px-4 max-w-4xl pt-8 pb-10">

      <!-- 금주 당첨번호 입력 섹션 -->
<section id="winningSection" class="section-card p-6 border border-accent/20 mb-6">
  <h2 class="text-xl font-bold text-primary mb-3">금주 당첨번호 입력</h2>
  <form id="winningForm" class="flex gap-2 mb-2 flex-wrap">
    <input type="number" min="1" max="45" required class="w-14 p-2 border rounded" placeholder="1번" id="win1">
    <input type="number" min="1" max="45" required class="w-14 p-2 border rounded" placeholder="2번" id="win2">
    <input type="number" min="1" max="45" required class="w-14 p-2 border rounded" placeholder="3번" id="win3">
    <input type="number" min="1" max="45" required class="w-14 p-2 border rounded" placeholder="4번" id="win4">
    <input type="number" min="1" max="45" required class="w-14 p-2 border rounded" placeholder="5번" id="win5">
    <input type="number" min="1" max="45" required class="w-14 p-2 border rounded" placeholder="6번" id="win6">
    <input type="number" min="1" max="45" class="w-14 p-2 border rounded" placeholder="보너스" id="winBonus">
    <button type="submit" class="px-4 py-2 bg-primary text-white rounded font-bold ml-2">저장</button>
  </form>
  <div id="winningLatest" class="text-gray-600 text-sm"></div>
  <!-- 유저별 성적 표시 -->
  <div id="userResults" class="mt-6"></div>
</section>
    <!-- 탭 메뉴 -->
    <div class="flex border-b mb-6">
      <button id="tab-users" class="px-4 py-2 font-bold tab-active">회원관리</button>
      <button id="tab-qna" class="px-4 py-2 font-bold text-gray-500">Q&A 관리</button>
    </div>

    <!-- 회원관리 -->
    <section id="userSection" class="section-card p-6 border border-accent/20">
      <h2 class="text-xl font-bold text-primary mb-3">회원 목록</h2>
      <div id="userList" class="overflow-x-auto">
        <table class="table w-full text-center text-gray-700">
          <thead>
            <tr>
              <th class="py-2 px-3">이메일</th>
              <th class="py-2 px-3">닉네임</th>
              <th class="py-2 px-3">가입일</th>
              <th class="py-2 px-3">번호 발송</th>
            </tr>
          </thead>
          <tbody>
            <!-- 회원 리스트 JS로 로드 -->
          </tbody>
        </table>
      </div>
    </section>

    <!-- QnA 관리 (답변 모달 포함) -->
    <section id="qnaSection" class="section-card p-6 border border-accent/20 hidden">
      <h2 class="text-xl font-bold text-primary mb-3">Q&A 전체 목록</h2>
      <div id="qnaList" class="overflow-x-auto"></div>
    </section>

    <!-- 답변 모달 -->
    <div id="answerModal" class="fixed inset-0 bg-black/40 flex items-center justify-center z-50 hidden">
      <div class="bg-white rounded-xl shadow-xl p-8 max-w-md w-full relative">
        <button id="closeAnswerModal" class="absolute top-2 right-2 text-gray-400 hover:text-primary text-2xl">&times;</button>
        <h3 class="text-lg font-bold text-primary mb-4">Q&A 답변 작성</h3>
        <div class="mb-2 font-semibold" id="modalQTitle"></div>
        <div class="mb-4 text-gray-600" id="modalQContent"></div>
        <form id="answerForm" class="space-y-3">
          <textarea id="answerInput" class="w-full border rounded p-2" rows="4" placeholder="답변을 입력하세요" required></textarea>
          <button type="submit" class="px-4 py-2 bg-primary text-white rounded font-bold">저장</button>
        </form>
      </div>
    </div>

<!-- 추천번호 발송 모달 -->
<div id="sendModal" class="fixed inset-0 bg-black/40 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-xl shadow-xl p-8 max-w-md w-full">
    <h3 class="text-lg font-bold text-primary mb-4">추천번호 발송</h3>
    <div class="mb-2 text-gray-700" id="currentRoundInfo"></div>
    <form id="sendForm" class="space-y-3">
      <input type="hidden" id="sendEmail" />
      <div>
        <label class="block font-semibold mb-1">추천번호</label>
        <input type="text" id="sendNumbers" class="w-full p-2 border rounded" placeholder="예: 1, 3, 14, 26, 30, 44" required>
      </div>
      <div>
        <label class="block font-semibold mb-1">응원 메시지</label>
        <select id="cheerSelect" class="w-full p-2 border rounded mb-1">
          <option value="이번 주에는 행운이 함께 하시길!">이번 주에는 행운이 함께 하시길!</option>
          <option value="꿈은 이루어집니다!">꿈은 이루어집니다!</option>
          <option value="매주 행복한 한 주 보내세요!">매주 행복한 한 주 보내세요!</option>
          <option value="로또1081이 늘 응원합니다!">로또1081이 늘 응원합니다!</option>
        </select>
        <input type="text" id="customCheer" class="w-full p-2 border rounded mt-1" placeholder="직접 입력 (선택)" />
        <small class="text-gray-400">직접 입력하면 선택 메시지 대신 사용됩니다.</small>
      </div>
      <div class="flex gap-2">
        <button type="button" id="autoNumber" class="px-3 py-1 bg-accent text-white rounded">자동추천</button>
        <button type="submit" class="px-4 py-1 bg-primary text-white rounded font-bold">발송</button>
        <button type="button" id="closeSendModal" class="ml-auto px-4 py-1 bg-gray-200 rounded">취소</button>
      </div>
    </form>
  </div>
</div>


    <!-- 회원별 추천번호 이력 모달 -->
    <div id="historyModal" class="fixed inset-0 bg-black/40 flex items-center justify-center z-50 hidden">
      <div class="bg-white rounded-xl shadow-xl p-8 max-w-md w-full relative">
        <button id="closeHistoryModal" class="absolute top-2 right-2 text-gray-400 hover:text-primary text-2xl">&times;</button>
        <h3 class="text-lg font-bold text-primary mb-4">회차별 추천번호 이력</h3>
        <div id="historyContent"></div>
      </div>
    </div>

  </main>





<div id="pwCover" style="position:fixed;z-index:9999;top:0;left:0;width:100vw;height:100vh;background:#fff;display:flex;align-items:center;justify-content:center;">
  <div>
    <input id="adminPw" type="password" placeholder="비밀번호 입력" />
    <button onclick="checkPw()">확인</button>
  </div>
</div>

  <script>
    // 1. 회차 자동계산 함수 (2025-06-21 = 1177회차)
    function getCurrentRound(today = new Date()) {
      const baseRound = 1177;
      const baseDate = new Date(2025, 5, 21); // 2025-06-21 (month 0-indexed)
      const diffMs = today - baseDate;
      const diffWeeks = Math.floor(diffMs / (1000 * 60 * 60 * 24 * 7));
      return baseRound + diffWeeks;
    }

    // 2. 탭 전환
    document.getElementById('tab-users').onclick = function() {
      document.getElementById('userSection').classList.remove('hidden');
      document.getElementById('qnaSection').classList.add('hidden');
      this.classList.add('tab-active');
      document.getElementById('tab-qna').classList.remove('tab-active');
    };
    document.getElementById('tab-qna').onclick = function() {
      document.getElementById('userSection').classList.add('hidden');
      document.getElementById('qnaSection').classList.remove('hidden');
      this.classList.add('tab-active');
      document.getElementById('tab-users').classList.remove('tab-active');
      loadQnaList();
    };

    // 3. 회원 목록 불러오기 + 이메일 클릭시 이력 확인
    function loadUsers() {
      const tbody = document.querySelector('#userList tbody');
      tbody.innerHTML = '';
      firebase.firestore().collection('users').get().then(snapshot => {
        snapshot.forEach(doc => {
          const user = doc.data();
          const userId = user.userId || '-';
          const nickname = user.name || '-';
          const created = user.createdAt && user.createdAt.toDate ? user.createdAt.toDate().toLocaleDateString() : '-';
          tbody.innerHTML += `
            <tr>
              <td class="py-2 px-3 email-cell cursor-pointer text-blue-700 hover:underline">${userId}</td>
              <td class="py-2 px-3">${nickname}</td>
              <td class="py-2 px-3">${created}</td>
              <td class="py-2 px-3">
                <button class="sendBtn px-3 py-1 bg-primary text-white rounded" data-email="${userId}">발송</button>
              </td>
            </tr>
          `;
        });
        document.querySelectorAll('.sendBtn').forEach(btn => {
          btn.onclick = () => openSendModal(btn.getAttribute('data-email'));
        });
        document.querySelectorAll('.email-cell').forEach(td => {
          td.onclick = () => openHistoryModal(td.textContent);
        });
      });
    }

    // 4. 추천번호 발송 모달 열기 (회차 안내 포함)
    function openSendModal(userId) {
      document.getElementById('sendEmail').value = userId;
      document.getElementById('sendNumbers').value = '';
      // 회차 정보 안내
      const round = getCurrentRound();
      const today = new Date();
      const weekEnd = new Date(today.getFullYear(), today.getMonth(), today.getDate() + (6 - today.getDay())); // 토요일(6)까지 남은 날
      document.getElementById('currentRoundInfo').innerHTML = `<span class="text-primary font-bold">${round}회차</span> (${weekEnd.getFullYear()}-${String(weekEnd.getMonth()+1).padStart(2,'0')}-${String(weekEnd.getDate()).padStart(2,'0')}) 추첨분`;
      document.getElementById('sendModal').classList.remove('hidden');
    }
    document.getElementById('closeSendModal').onclick = () => {
      document.getElementById('sendModal').classList.add('hidden');
    };

    // 5. 자동 추천번호(랜덤)
    document.getElementById('autoNumber').onclick = function(e) {
      e.preventDefault();
      const nums = [];
      while (nums.length < 6) {
        const n = Math.floor(Math.random() * 45) + 1;
        if (!nums.includes(n)) nums.push(n);
      }
      nums.sort((a, b) => a - b);
      document.getElementById('sendNumbers').value = nums.join(', ');
    };

    // 6. 추천번호 발송(파이어스토어에 회차까지 기록)

    // 7. 회원 이력 모달 열기 (회차별 추천번호 보기)
function openHistoryModal(userId) {
  const modal = document.getElementById('historyModal');
  const contentDiv = document.getElementById('historyContent');
  contentDiv.innerHTML = '<div class="text-gray-500 text-center py-4">로딩 중...</div>';
  modal.classList.remove('hidden');

  firebase.firestore().collection('recommendations')
    .where('userId', '==', userId)
    .orderBy('sentAt', 'desc') // ← 여기만 바꿔주면 됨
    .get()
    .then(snapshot => {
      if (snapshot.empty) {
        contentDiv.innerHTML = '<div class="text-gray-500 text-center py-4">추천번호 이력이 없습니다.</div>';
        return;
      }
      let html = `<table class="w-full text-center border mt-2">
        <thead>
          <tr class="bg-gray-50">
            <th class="py-1 px-2">회차</th>
            <th class="py-1 px-2">추천번호</th>
            <th class="py-1 px-2">발송일</th>
          </tr>
        </thead>
        <tbody>`;
      snapshot.forEach(doc => {
        const data = doc.data();
        const dt = data.sentAt && data.sentAt.toDate ? data.sentAt.toDate().toLocaleDateString() : '';
        html += `<tr>
          <td class="py-1 px-2 font-bold">${data.round || '-'}</td>
          <td class="py-1 px-2">${data.numbers}</td>
          <td class="py-1 px-2">${dt}</td>
        </tr>`;
      });
      html += '</tbody></table>';
      contentDiv.innerHTML = html;
    });
}


    document.getElementById('closeHistoryModal').onclick = () => {
      document.getElementById('historyModal').classList.add('hidden');
    };

    // 8. QnA 전체 목록 불러오기 (기존 코드 유지)
    function loadQnaList() {
      const div = document.getElementById('qnaList');
      div.innerHTML = '';
      firebase.firestore().collection('qna').orderBy('createdAt', 'desc').get().then(snapshot => {
        if (snapshot.empty) {
          div.innerHTML = '<p class="py-6 text-accent text-center">Q&A가 없습니다.</p>';
          return;
        }
        div.innerHTML = `<table class="table w-full text-center text-gray-700">
          <thead>
            <tr>
              <th class="py-2 px-3">제목</th>
              <th class="py-2 px-3">이메일</th>
              <th class="py-2 px-3">작성일</th>
              <th class="py-2 px-3">답변상태</th>
              <th class="py-2 px-3">관리</th>
            </tr>
          </thead>
          <tbody>
            ${snapshot.docs.map(doc => {
              const q = doc.data();
              const date = q.createdAt && q.createdAt.toDate ? q.createdAt.toDate().toLocaleDateString() : '';
              return `
                <tr>
                  <td class="py-2 px-3 text-left">${q.title}</td>
                  <td class="py-2 px-3">${q.email || ''}</td>
                  <td class="py-2 px-3">${date}</td>
                  <td class="py-2 px-3">
                    ${q.answer && q.answer.trim() ? '<span class="status-paid">완료</span>' : '<span class="status-expired">대기</span>'}
                  </td>
                  <td class="py-2 px-3">
                    <button class="answerBtn bg-accent text-white rounded px-3 py-1" 
                      data-id="${doc.id}" 
                      data-title="${q.title}" 
                      data-content="${q.content}" 
                      data-answer="${q.answer || ''}">
                      ${q.answer && q.answer.trim() ? '수정' : '답변'}
                    </button>
                  </td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>`;
        document.querySelectorAll('.answerBtn').forEach(btn => {
          btn.onclick = function() {
            openAnswerModal(
              this.getAttribute('data-id'),
              this.getAttribute('data-title'),
              this.getAttribute('data-content'),
              this.getAttribute('data-answer')
            );
          };
        });
      });
    }

    // QnA 답변 모달 열기/닫기
    function openAnswerModal(id, title, content, answer) {
      document.getElementById('answerModal').classList.remove('hidden');
      document.getElementById('modalQTitle').textContent = title;
      document.getElementById('modalQContent').textContent = content;
      document.getElementById('answerInput').value = answer || '';
      document.getElementById('answerForm').onsubmit = function(e) {
        e.preventDefault();
        const val = document.getElementById('answerInput').value.trim();
        firebase.firestore().collection('qna').doc(id).update({ answer: val })
          .then(() => {
            document.getElementById('answerModal').classList.add('hidden');
            loadQnaList();
          });
      };
    }
    document.getElementById('closeAnswerModal').onclick = () => {
      document.getElementById('answerModal').classList.add('hidden');
    };

    // 첫 진입시 회원 목록 로드
    loadUsers();
document.getElementById('sendForm').onsubmit = async function(e) {
  e.preventDefault();
  const userId = document.getElementById('sendEmail').value;
  const numbers = document.getElementById('sendNumbers').value;
  const round = getCurrentRound();
  const now = new Date();
  const selectMsg = document.getElementById('cheerSelect').value;
  const customMsg = document.getElementById('customCheer').value.trim();
  // 직접 입력이 있으면 custom, 아니면 select 값
  const cheerMsg = customMsg ? customMsg : selectMsg;

  // 1. 파이어스토어 저장
  await firebase.firestore().collection('recommendations').add({
    userId,
    numbers,
    round,
    sentAt: now,
    cheerMsg  // 추가로 응원 메시지도 저장하면 좋음
  });

  // 2. 사용자 전화번호 찾기
  let phone = '';
  const userDoc = await firebase.firestore().collection('users').where('userId', '==', userId).get();
  if (!userDoc.empty) {
    phone = userDoc.docs[0].data().phone;
  }
  if (phone) {
    fetch('http://localhost:4000/send-sms', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        to: phone,
        numbers: numbers,
        message: cheerMsg   // ← 메시지도 함께 전송
      })
    })
      .then(r => r.json())
      .then(result => {
        if (result.success) {
          alert('추천번호가 저장되고 문자로도 발송되었습니다.');
        } else {
          alert('문자 발송 실패: ' + JSON.stringify(result.error));
        }
      })
      .catch(err => alert('문자 발송 에러: ' + err));
  } else {
    alert('사용자 전화번호를 찾을 수 없습니다. Firestore에 전화번호를 추가해 주세요.');
  }

  document.getElementById('sendModal').classList.add('hidden');
};


//여기서부터 아래는 금주의 당첨번호

// 금주 당첨번호 입력 및 Firestore 저장
document.getElementById('winningForm').onsubmit = async function(e) {
  e.preventDefault();
  const round = getCurrentRound();
  const numbers = [
    Number(document.getElementById('win1').value),
    Number(document.getElementById('win2').value),
    Number(document.getElementById('win3').value),
    Number(document.getElementById('win4').value),
    Number(document.getElementById('win5').value),
    Number(document.getElementById('win6').value)
  ];
  const bonus = Number(document.getElementById('winBonus').value) || null;

  // 중복/범위 체크
  if (new Set(numbers).size !== 6 || numbers.some(n => n < 1 || n > 45)) {
    alert('1~45 사이의 중복 없는 6개 번호를 입력하세요.');
    return;
  }
  if (bonus && (numbers.includes(bonus) || bonus < 1 || bonus > 45)) {
    alert('보너스 번호는 1~45 사이, 기존 6개와 겹치면 안됩니다.');
    return;
  }

  await firebase.firestore().collection('winningNumbers').add({
    round,
    numbers,
    bonus,
    createdAt: new Date()
  });
  alert('금주 당첨번호가 저장되었습니다.');
  loadLatestWinningNumber(); // 최신 당첨번호 다시 로드
};

// 최신 당첨번호 보여주기
async function loadLatestWinningNumber() {
  const div = document.getElementById('winningLatest');
  div.textContent = '불러오는 중...';
  const round = Number(getCurrentRound());
  const q = await firebase.firestore()
    .collection('winningNumbers')
    .where('round', '==', round)
    .orderBy('createdAt', 'desc')
    .limit(1)
    .get();
  if (q.empty) {
    div.textContent = `이번주(${round}회차) 당첨번호가 입력되지 않았습니다.`;
  } else {
    const data = q.docs[0].data();
    div.innerHTML = `<b>${data.round}회차</b> | ${data.numbers.join(', ')}${data.bonus ? ' + 보너스: ' + data.bonus : ''}`;
    // 입력폼에도 불러오기
    data.numbers.forEach((num, idx) => {
      document.getElementById('win' + (idx+1)).value = num;
    });
    if (data.bonus) document.getElementById('winBonus').value = data.bonus;
  }
}


// 진입시 최신 당첨번호도 같이 로드
loadLatestWinningNumber();


// 여기서부터 유저 성적 확인
async function checkUserResult(userId) {
  const round = Number(getCurrentRound());
  // 추천번호 불러오기
  const recSnap = await firebase.firestore()
    .collection('recommendations')
    .where('userId', '==', userId)
    .where('round', '==', round)
    .limit(1)
    .get();
  if (recSnap.empty) return { error: "추천번호 기록 없음" };
  const recData = recSnap.docs[0].data();
  const userNums = recData.numbers
    .split(',')
    .map(s => Number(s.trim()))
    .filter(n => !isNaN(n));

  // 당첨번호 불러오기
  const winSnap = await firebase.firestore()
    .collection('winningNumbers')
    .where('round', '==', round)
    .orderBy('createdAt', 'desc')
    .limit(1)
    .get();
  if (winSnap.empty) return { error: "해당 회차 당첨번호 없음" };
  const winData = winSnap.docs[0].data();
  const winNums = winData.numbers.map(n => Number(n));
  const bonus = Number(winData.bonus);

  // 일치 계산
  const match = userNums.filter(n => winNums.includes(n));
  const matchCount = match.length;
  const bonusMatch = bonus && userNums.includes(bonus);

  return {
    userId,
    round,
    userNums,
    winNums,
    match,
    matchCount,
    bonus,
    bonusMatch
  };
}


//여기서부터 불러오기
async function loadUserResults() {
  const div = document.getElementById('userResults');
  div.innerHTML = '<div class="text-gray-500">불러오는 중...</div>';
  const round = Number(getCurrentRound());

  const [usersSnap, winSnap, recsSnap] = await Promise.all([
    firebase.firestore().collection('users').get(),
    firebase.firestore().collection('winningNumbers').where('round', '==', round).orderBy('createdAt', 'desc').limit(1).get(),
    firebase.firestore().collection('recommendations').where('round', '==', round).get(),
  ]);

  if (usersSnap.empty) {
    div.innerHTML = '<div class="text-gray-500">가입한 회원이 없습니다.</div>';
    return;
  }
  if (winSnap.empty) {
    div.innerHTML = '<div class="text-gray-500">이번 회차 당첨번호가 없습니다.</div>';
    return;
  }

  const winData = winSnap.docs[0].data();
  const winNums = winData.numbers.map(Number);
  const bonus = Number(winData.bonus);
  
  // map: userId → 추천번호
// map: userId → 추천번호 배열
const recsMap = {};
recsSnap.forEach(doc => {
  const rec = doc.data();
  // 모든 userId, numbers 값에 trim 적용
  const key = (rec.userId || '').trim();
  const nums = (rec.numbers || '').trim();
  if (!recsMap[key]) recsMap[key] = [];
  recsMap[key].push(nums);
});

    let html = `
      <table class="table w-full text-center mt-4">
        <thead>
          <tr>
            <th class="py-2 px-3">이메일</th>
            <th class="py-2 px-3">닉네임</th>
            <th class="py-2 px-3">추천번호</th>
            <th class="py-2 px-3">일치</th>
            <th class="py-2 px-3">보너스</th>
            <th class="py-2 px-3">등수</th>   <!-- 👈 추가 -->
          </tr>
        </thead>
        <tbody>
    `;


usersSnap.forEach(doc => {
  const user = doc.data();
  const userId = user.userId;
  const name = user.name || '-';
  const numsArr = recsMap[userId];
   console.log("userId:", userId, "numsArr:", numsArr); // 디버깅 로그
  if (!numsArr || numsArr.length === 0) {
    html += `<tr>
      <td class="py-1 px-2">${userId}</td>
      <td class="py-1 px-2">${name}</td>
      <td class="py-1 px-2 text-gray-400">-</td>
      <td class="py-1 px-2 text-gray-400">-</td>
      <td class="py-1 px-2 text-gray-400">-</td>
      <td class="py-1 px-2 text-gray-400">-</td>
    </tr>`;
    return;
  }

  // 여러 추천번호 중 “최고 등수”로 채택
  let best = {
    matchCount: 0,
    match: [],
    bonusMatch: false,
    rankValue: 10, // 1등:1, 2등:2... 5등:5, -:10
    rank: "-",
    nums: ""
    
  };
numsArr.forEach(numsStr => {
    const userNums = numsStr.split(',').map(s => Number(s.trim())).filter(n => !isNaN(n));
    console.log("userNums:", userNums, "| winNums:", winNums); // 여기까지만 디버깅
    const match = userNums.filter(n => winNums.includes(n));
    const bonusMatch = bonus && userNums.includes(bonus);
    const rank = getLottoRank(match.length, bonusMatch);
    const rankValue = getRankValue(match.length, bonusMatch);
    if (rankValue < best.rankValue) {
      best = {
        matchCount: match.length,
        match,
        bonusMatch,
        rankValue,
        rank,
        nums: userNums.join(', ')
      };
    }
  });

  html += `<tr>
    <td class="py-1 px-2">${userId}</td>
    <td class="py-1 px-2">${name}</td>
    <td class="py-1 px-2">${best.nums}</td>
    <td class="py-1 px-2 font-bold">${best.matchCount}개 (${best.match.join(', ')})</td>
    <td class="py-1 px-2">${best.bonusMatch ? 'O' : 'X'}</td>
    <td class="py-1 px-2 font-bold">${best.rank}</td>
  </tr>`;
});

// 등수의 숫자값 (등수가 낮을수록 1등)
function getRankValue(matchCount, bonusMatch) {
  if (matchCount === 6) return 1;
  if (matchCount === 5 && bonusMatch) return 2;
  if (matchCount === 5) return 3;
  if (matchCount === 4) return 4;
  if (matchCount === 3) return 5;
  return 10; // 미당첨
}



  html += '</tbody></table>';
  div.innerHTML = html;
}

function getLottoRank(matchCount, bonusMatch) {
  if (matchCount === 6) return "1등";
  if (matchCount === 5 && bonusMatch) return "2등";
  if (matchCount === 5) return "3등";
  if (matchCount === 4) return "4등";
  if (matchCount === 3) return "5등";
  return "-";
}



// 진입시 최신 당첨번호도 같이 로드
loadLatestWinningNumber();
loadUserResults();

document.getElementById('winningForm').onsubmit = async function(e) {
  e.preventDefault();
  const round = getCurrentRound();
  const numbers = [
    Number(document.getElementById('win1').value),
    Number(document.getElementById('win2').value),
    Number(document.getElementById('win3').value),
    Number(document.getElementById('win4').value),
    Number(document.getElementById('win5').value),
    Number(document.getElementById('win6').value)
  ];
  const bonus = Number(document.getElementById('winBonus').value) || null;

  // 중복/범위 체크
  if (new Set(numbers).size !== 6 || numbers.some(n => n < 1 || n > 45)) {
    alert('1~45 사이의 중복 없는 6개 번호를 입력하세요.');
    return;
  }
  if (bonus && (numbers.includes(bonus) || bonus < 1 || bonus > 45)) {
    alert('보너스 번호는 1~45 사이, 기존 6개와 겹치면 안됩니다.');
    return;
  }

  await firebase.firestore().collection('winningNumbers').add({
    round,
    numbers,
    bonus,
    createdAt: new Date()
  });
  alert('금주 당첨번호가 저장되었습니다.');
  loadLatestWinningNumber();
  loadUserResults();
};





  </script>


<script>
  function checkPw() {
    const pw = document.getElementById('adminPw').value;
    if (pw === '1081') {
      document.getElementById('pwCover').style.display = 'none';
    } else {
      alert('비밀번호가 틀렸습니다.');
    }
  }
</script>
</body>
</html>