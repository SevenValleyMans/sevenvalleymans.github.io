<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>로또1081 관리자</title>
  <link rel="icon" href="https://lotto1081.com/allFile/logo.jpg" type="image">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBH3AvpxtOF7NQDH_fDOuAXSyEfw8r5kbU",
      authDomain: "lotto1081-2b3dc.firebaseapp.com",
      projectId: "lotto1081-2b3dc",
      storageBucket: "lotto1081-2b3dc.appspot.com",
      messagingSenderId: "785261698548",
      appId: "1:785261698548:web:84531550d2380c24f82da1",
    };
    firebase.initializeApp(firebaseConfig);
  </script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#8B0000',
            secondary: '#D4AF37',
            accent: '#64748B',
            light: '#F8FAFC',
          },
          fontFamily: {
            sans: ['Noto Sans KR', 'sans-serif'],
          },
          backgroundImage: {
            'gradient-radial': 'radial-gradient(var(--tw-gradient-stops))',
            'hero-pattern': "url('data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%238B0000' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E')",
          },
        },
      },
    }
  </script>
  <style>
    body { font-family: 'Noto Sans KR', sans-serif; }
    .section-card { background: #fff; border-radius: 1rem; box-shadow: 0 4px 24px rgba(30,58,138,0.07);}
    .table thead { background: #F8FAFC; }
    .tab-active { color: #8B0000; border-bottom: 2px solid #8B0000; }
    .status-paid { color: #22c55e; font-weight: bold; }
    .status-expired { color: #f87171; }
  </style>
</head>
<body class="bg-light min-h-screen">
  <nav class="fixed w-full bg-white/90 shadow-sm z-50 border-b border-accent/20">
    <div class="container mx-auto px-4 flex items-center justify-between h-16">
      <span class="text-2xl font-bold text-primary">로또1081 관리자</span>
    </div>
  </nav>
  <div class="h-16"></div>

  <main class="container mx-auto px-4 max-w-4xl pt-8 pb-10">

    <!-- 금주 당첨번호 입력 섹션 -->
    <section id="winningSection" class="section-card p-6 border border-accent/20 mb-6">
      <h2 class="text-xl font-bold text-primary mb-3">금주 당첨번호 입력</h2>
      <div class="flex justify-between items-center mb-3">
  <button id="downloadResultCSV" class="px-4 py-2 bg-accent text-white rounded font-bold hover:bg-primary transition">
    엑셀 다운
  </button>
</div>

      <form id="winningForm" class="flex gap-2 mb-2 flex-wrap">
        <input type="number" min="1" max="45" required class="w-14 p-2 border rounded" placeholder="1번" id="win1">
        <input type="number" min="1" max="45" required class="w-14 p-2 border rounded" placeholder="2번" id="win2">
        <input type="number" min="1" max="45" required class="w-14 p-2 border rounded" placeholder="3번" id="win3">
        <input type="number" min="1" max="45" required class="w-14 p-2 border rounded" placeholder="4번" id="win4">
        <input type="number" min="1" max="45" required class="w-14 p-2 border rounded" placeholder="5번" id="win5">
        <input type="number" min="1" max="45" required class="w-14 p-2 border rounded" placeholder="6번" id="win6">
        <input type="number" min="1" max="45" class="w-14 p-2 border rounded" placeholder="보너스" id="winBonus">
        <button type="submit" class="px-4 py-2 bg-primary text-white rounded font-bold ml-2">저장</button>
      </form>
      <div id="winningLatest" class="text-gray-600 text-sm"></div>
      <div id="userResults" class="mt-6"></div>
      
    </section>

    <!-- 예약 발송 내역 섹션 -->
    <section id="scheduleSection" class="section-card p-6 border border-accent/20 mb-6">
      <h2 class="text-xl font-bold text-primary mb-3">예약 발송 내역</h2>
      <div id="scheduleList" class="overflow-x-auto"></div>
    </section>

    <!-- 탭 메뉴 -->
    <div class="flex border-b mb-6">
      <button id="tab-users" class="px-4 py-2 tab-active font-bold">회원관리</button>
      <button id="tab-qna" class="px-4 py-2 font-bold text-gray-500">Q&A 관리</button>
      <button id="tab-approve" class="px-4 py-2 font-bold text-gray-500">입금승인대기</button>
    </div>

    <!-- 회원관리 -->
    <section id="userSection" class="section-card p-6 border border-accent/20">
      <div class="flex justify-between items-center mb-3">
        <h2 class="text-xl font-bold text-primary">회원 목록</h2>
        <button id="selectedDeleteBtn" class="px-4 py-2 bg-red-500 text-white rounded font-bold hover:bg-primary transition ml-2">선택회원 멤버십 해지</button>
         <button id="selectedSendBtn" class="px-4 py-2 bg-secondary text-white rounded font-bold hover:bg-primary transition">선택회원 발송</button>
      </div>
      <div id="userList" class="overflow-x-auto">
        <table class="table w-full text-center text-gray-700">
          <thead>
            <tr>
              <th class="py-2 px-3">체크박스</th>
              <th class="py-2 px-3">이메일</th>
              <th class="py-2 px-3">닉네임</th>
              <th class="py-2 px-3">가입일</th>
              <th class="py-2 px-3">회원구분</th>
              <th class="py-2 px-3">이번주 발송</th>
            </tr>
          </thead>
          <tbody>
            <!-- 회원 리스트 JS로 로드 -->
          </tbody>
        </table>
      </div>
    </section>

    <!-- QnA 관리 (답변 모달 포함) -->
    <section id="qnaSection" class="section-card p-6 border border-accent/20 hidden">
      <h2 class="text-xl font-bold text-primary mb-3">Q&A 전체 목록</h2>
      <div id="qnaList" class="overflow-x-auto"></div>
    </section>


    <section id="approveSection" class="section-card p-6 border border-accent/20 hidden">
      <h2 class="text-xl font-bold text-primary mb-3">입금 승인 대기 명단</h2>
      <div id="approveList" class="overflow-x-auto"></div>
    </section>

    <!-- 답변 모달 -->
    <div id="answerModal" class="fixed inset-0 bg-black/40 flex items-center justify-center z-50 hidden">
      <div class="bg-white rounded-xl shadow-xl p-8 max-w-md w-full relative">
        <button id="closeAnswerModal" class="absolute top-2 right-2 text-gray-400 hover:text-primary text-2xl">&times;</button>
        <h3 class="text-lg font-bold text-primary mb-4">Q&A 답변 작성</h3>
        <div class="mb-2 font-semibold" id="modalQTitle"></div>
        <div class="mb-4 text-gray-600" id="modalQContent"></div>
        <form id="answerForm" class="space-y-3">
          <textarea id="answerInput" class="w-full border rounded p-2" rows="4" placeholder="답변을 입력하세요" required></textarea>
          <button type="submit" class="px-4 py-2 bg-primary text-white rounded font-bold">저장</button>
        </form>
      </div>
    </div>

    <!-- 추천번호 발송 모달 (예약 필드 추가) -->
    <div id="sendModal" class="fixed inset-0 bg-black/40 flex items-center justify-center z-50 hidden">
      <div class="bg-white rounded-xl shadow-xl p-8 max-w-md w-full max-h-[80vh] overflow-y-auto">
        <h3 class="text-lg font-bold text-primary mb-4">추천번호 발송</h3>
        <div class="mb-2 text-gray-700" id="currentRoundInfo"></div>
        <form id="sendForm" class="space-y-3">
          <input type="hidden" id="sendEmail" />
          <div>
            <label class="block font-semibold mb-1">추천번호 조합<br>
              <span class="text-xs text-gray-400">각 조합을 한 줄에 1개씩, 예: 1,3,11,18,30,42</span>
            </label>
            <textarea id="sendNumbers" class="w-full p-2 border rounded" placeholder="예:&#10;1,3,11,18,30,42&#10;7,8,17,24,31,45&#10;..." rows="10" required></textarea>
          </div>
          <div>
            <label class="block font-semibold mb-1">응원 메시지</label>
            <select id="cheerSelect" class="w-full p-2 border rounded mb-1">
              <option value="이번 주에는 행운이 함께 하시길!">이번 주에는 행운이 함께 하시길!</option>
              <option value="꿈은 이루어집니다!">꿈은 이루어집니다!</option>
              <option value="매주 행복한 한 주 보내세요!">매주 행복한 한 주 보내세요!</option>
              <option value="로또1081이 늘 응원합니다!">로또1081이 늘 응원합니다!</option>
            </select>
            <input type="text" id="customCheer" class="w-full p-2 border rounded mt-1" placeholder="직접 입력 (선택)" />
            <small class="text-gray-400">직접 입력하면 선택 메시지 대신 사용됩니다.</small>
          </div>
          <div>
            <label class="block font-semibold mb-1">예약 발송 시간</label>
            <input type="datetime-local" id="sendSchedule" class="w-full p-2 border rounded" />
            <small class="text-gray-400">비워두면 즉시 발송</small>
          </div>
          <div class="flex gap-2">
            <button type="submit" class="px-4 py-1 bg-primary text-white rounded font-bold">발송</button>
            <button type="button" id="closeSendModal" class="ml-auto px-4 py-1 bg-gray-200 rounded">취소</button>
          </div>
        </form>
      </div>
    </div>

    <!-- 일괄 발송 모달 (예약 필드 추가) -->


    <!-- 회원별 추천번호 이력 모달 -->
    <div id="historyModal" class="fixed inset-0 bg-black/40 flex items-center justify-center z-50 hidden">
      <div class="bg-white rounded-xl shadow-xl p-8 max-w-2xl w-full relative">
        <button id="closeHistoryModal" class="absolute top-2 right-2 text-gray-400 hover:text-primary text-2xl">&times;</button>
        <h3 class="text-lg font-bold text-primary mb-4">회차별 추천번호 이력</h3>
        <div id="historyContent" class="max-h-[75vh] overflow-y-auto"></div>
      </div>
    </div>





    <!-- 선택회원 발송 모달 (html 어디든 추가) -->
<div id="selectedSendModal" class="fixed inset-0 bg-black/40 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-xl shadow-xl p-8 max-w-lg w-full relative max-h-[80vh] overflow-y-auto">
    <button id="closeSelectedSendModal" class="absolute top-2 right-2 text-gray-400 hover:text-primary text-2xl">&times;</button>
    <h3 class="text-lg font-bold text-primary mb-4">선택회원 발송</h3>
    <div class="mb-2 text-gray-700">발송 대상: <span id="selectedSendList" class="font-semibold"></span></div>
    <form id="selectedSendForm" class="space-y-3">
      <div>
        <label class="block font-semibold mb-1">추천번호 조합 (최소 30개)<br>
          <span class="text-xs text-gray-400">각 조합을 한 줄에 1개씩, 예: 1,3,11,18,30,42</span>
        </label>
        <textarea id="selectedNumbers" class="w-full p-2 border rounded" placeholder="예:&#10;1,3,11,18,30,42&#10;7,8,17,24,31,45&#10;..." rows="12" required></textarea>
      </div>
      <div>
        <label class="block font-semibold mb-1">응원 메시지</label>
        <select id="selectedCheerSelect" class="w-full p-2 border rounded mb-1">
          <option value="이번 주에는 행운이 함께 하시길!">이번 주에는 행운이 함께 하시길!</option>
          <option value="꿈은 이루어집니다!">꿈은 이루어집니다!</option>
          <option value="매주 행복한 한 주 보내세요!">매주 행복한 한 주 보내세요!</option>
          <option value="로또1081이 늘 응원합니다!">로또1081이 늘 응원합니다!</option>
        </select>
        <input type="text" id="selectedCustomCheer" class="w-full p-2 border rounded mt-1" placeholder="직접 입력 (선택)" />
        <small class="text-gray-400">직접 입력하면 선택 메시지 대신 사용됩니다.</small>
      </div>
      <div>
        <label class="block font-semibold mb-1">예약 발송 시간</label>
        <input type="datetime-local" id="selectedSendSchedule" class="w-full p-2 border rounded" />
        <small class="text-gray-400">비워두면 즉시 발송</small>
      </div>
      <div class="flex gap-2">
        <button type="submit" class="px-4 py-1 bg-primary text-white rounded font-bold">발송</button>
        <button type="button" id="closeSelectedSendModal2" class="ml-auto px-4 py-1 bg-gray-200 rounded">취소</button>
      </div>
      <div id="selectedSendResult" class="text-sm text-gray-700 mt-2"></div>
    </form>
  </div>
</div>

  </main>

  <!-- <div id="pwCover" style="position:fixed;z-index:9999;top:0;left:0;width:100vw;height:100vh;background:#fff;display:flex;align-items:center;justify-content:center;">
    <div>
      <input id="adminPw" type="password" placeholder="비밀번호 입력" />
      <button onclick="checkPw()">확인</button>
    </div>
  </div> -->

  <!-- 아래 script 부분 전체 붙여넣기 -->
  <script>
    // ---- 회차 계산 함수 ----
    function getCurrentRound(now = new Date()) {
      const baseRound = 1178;
      // 기준 시점: 2025-06-21 토요일 20:00 (month는 0-indexed, 5=6월)
      const baseDate = new Date(2025, 5, 21, 20, 0, 0, 0); // 2025-06-21   20:00:00

      // 현재 시점이 baseDate 이전이면 baseRound로 고정
      if (now < baseDate) return baseRound;

      // 기준 이후 지난 전체 주차(=경과한 토요일 20시 개수) 계산
      // 한 주는 7 * 24 * 60 * 60 * 1000 = 604800000 ms
      const diffMs = now - baseDate;
      const diffWeeks = Math.floor(diffMs / 604800000);
      // 이번 주 토요일 20시 구하기
      const thisSat20 = new Date(now);
      thisSat20.setHours(20,0,0,0);
      // 오늘이 토요일이고, 20시 전이면 아직 회차 증가X
      if (
        now.getDay() === 6 && now < thisSat20
      ) {
        return baseRound + diffWeeks;
      } else {
        // 토요일 20시 이후거나 다른 요일이면, 해당 주 회차
        return baseRound + diffWeeks + (now >= thisSat20 ? 1 : 0);
      }
    }

    // ---- 탭 전환 ----
   // 1. 탭/섹션 id 미리 변수에 저장(오타 방지)
const tabUsers = document.getElementById('tab-users');
const tabQna = document.getElementById('tab-qna');
const tabApprove = document.getElementById('tab-approve');
const userSection = document.getElementById('userSection');
const qnaSection = document.getElementById('qnaSection');
const approveSection = document.getElementById('approveSection');

// 2. 탭 클릭 시 모두 숨기고, 자신만 보이게!
tabUsers.onclick = function() {
  tabUsers.classList.add('tab-active'); tabUsers.classList.remove('text-gray-500');
  tabQna.classList.remove('tab-active'); tabQna.classList.add('text-gray-500');
  tabApprove.classList.remove('tab-active'); tabApprove.classList.add('text-gray-500');
  userSection.classList.remove('hidden');
  qnaSection.classList.add('hidden');
  approveSection.classList.add('hidden');
  loadUsers();
};

tabQna.onclick = function() {
  tabQna.classList.add('tab-active'); tabQna.classList.remove('text-gray-500');
  tabUsers.classList.remove('tab-active'); tabUsers.classList.add('text-gray-500');
  tabApprove.classList.remove('tab-active'); tabApprove.classList.add('text-gray-500');
  userSection.classList.add('hidden');
  qnaSection.classList.remove('hidden');
  approveSection.classList.add('hidden');
  loadQnaList();
};

tabApprove.onclick = function() {
  tabApprove.classList.add('tab-active'); tabApprove.classList.remove('text-gray-500');
  tabUsers.classList.remove('tab-active'); tabUsers.classList.add('text-gray-500');
  tabQna.classList.remove('tab-active'); tabQna.classList.add('text-gray-500');
  userSection.classList.add('hidden');
  qnaSection.classList.add('hidden');
  approveSection.classList.remove('hidden');
  loadApproveList();
};


    // ---- 회원 목록 불러오기 ----
function loadUsers() {
  const tbody = document.querySelector('#userList tbody');
  tbody.innerHTML = '';
  const round = getCurrentRound(); // 이번주 회차
  // 1. 모든 회원 정보 가져오기
  firebase.firestore().collection('users').get().then(async usersSnapshot => {
    // 2. 이번주 추천번호 전체 불러오기 (userId:round)
    const recSnap = await firebase.firestore()
      .collection('recommendations')
      .where('round', '==', round)
      .get();
    const receivedUsers = new Set();
    recSnap.forEach(doc => {
      const rec = doc.data();
      if (rec.userId) receivedUsers.add(rec.userId);
    });

    usersSnapshot.forEach(doc => {
      const user = doc.data();
      const userId = user.userId || '-';
      const nickname = user.name || '-';
      const created = user.createdAt && user.createdAt.toDate ? user.createdAt.toDate().toLocaleDateString() : '-';
      const isMember = user.membership === true;
// 플랜 종류 파싱
let membershipText = '일반회원';
if (isMember) {
  if (user.plan) {
    // BASIC, PREMIUM 등 모두 대문자로 표시
    const plan = user.plan.toUpperCase();
    membershipText = `멤버십(${plan})`;
  } else if (user.membershipType) {
    // 혹시 옛날 membershipType 필드가 있을 때
    const plan = user.membershipType.toUpperCase();
    membershipText = `멤버십(${plan})`;
  } else {
    membershipText = '멤버십(알수없음)';
  }
}


      // ★ 금주 발송 여부 체크
      const sentThisWeek = receivedUsers.has(userId) ? 'O' : '-';

      tbody.innerHTML += `
        <tr>
           <td class="py-2 px-3">
      <input type="checkbox" class="user-checkbox" data-email="${userId}" ${!isMember ? 'disabled' : ''}>
    </td>
          <td class="py-2 px-3 email-cell cursor-pointer text-blue-700 hover:underline">${userId}</td>
          <td class="py-2 px-3">${nickname}</td>
          <td class="py-2 px-3">${created}</td>
          <td class="py-2 px-3">${membershipText}</td>
          <td class="py-2 px-3">${sentThisWeek}</td>

        </tr>
      `;
    });
    // ...버튼 이벤트 부분은 기존 코드와 동일
    document.querySelectorAll('.sendBtn').forEach(btn => {
      if (btn.disabled) return;
      btn.onclick = () => openSendModal(btn.getAttribute('data-email'));
    });
    document.querySelectorAll('.email-cell').forEach(td => {
      td.onclick = () => openHistoryModal(td.textContent);
    });
  });
}


    // ---- 추천번호 개별 발송 모달 ----
    function openSendModal(userId) {
      document.getElementById('sendEmail').value = userId;
      document.getElementById('sendNumbers').value = '';
      document.getElementById('sendSchedule').value = '';
      const round = getCurrentRound();
      const today = new Date();
      const weekEnd = new Date(today.getFullYear(), today.getMonth(), today.getDate() + (6 - today.getDay()));
      document.getElementById('currentRoundInfo').innerHTML = `<span class="text-primary font-bold">${round}회차</span> (${weekEnd.getFullYear()}-${String(weekEnd.getMonth()+1).padStart(2,'0')}-${String(weekEnd.getDate()).padStart(2,'0')}) 추첨분`;
      document.getElementById('sendModal').classList.remove('hidden');
    }
    document.getElementById('closeSendModal').onclick = () => {
      document.getElementById('sendModal').classList.add('hidden');
      setTimeout(() => {
        document.getElementById('sendModal').scrollIntoView({ behavior: "smooth", block: "center" });
      }, 50);
    };

    // ---- 추천번호 "개별 발송" (즉시/예약) ----
    document.getElementById('sendForm').onsubmit = async function(e) {
      e.preventDefault();
      const userId = document.getElementById('sendEmail').value;
      const textareaValue = document.getElementById('sendNumbers').value.trim();
      const round = getCurrentRound();
      const now = new Date();
      const selectMsg = document.getElementById('cheerSelect').value;
      const customMsg = document.getElementById('customCheer').value.trim();
      const cheerMsg = customMsg ? customMsg : selectMsg;
      const sendSchedule = document.getElementById('sendSchedule').value;

      // 파싱 및 30개 미만 차단
      const lines = textareaValue
        .split('\n')
        .map(line => line.replace(/\s/g, ''))
        .filter(line => !!line && line.split(',').length === 6 && line.split(',').every(n => !isNaN(Number(n)) && Number(n) >= 1 && Number(n) <= 45));
      const uniqueLines = Array.from(new Set(lines));
      if (uniqueLines.length < 5) {
        alert('30개 이상의 6자리 숫자 조합을 한 줄에 1개씩 입력해 주세요.');
        return;
      }
      // 30개 랜덤 선택
      const shuffled = uniqueLines
        .map(value => ({ value, sort: Math.random() }))
        .sort((a, b) => a.sort - b.sort)
        .map(({ value }) => value);
      const selectedNumbersArr = shuffled.slice(0, 30);

      if (sendSchedule) {
        // 예약 발송
        let sendAt = new Date(sendSchedule);
        if (sendAt <= new Date()) {
          alert('예약 발송 시각은 현재 시각 이후여야 합니다.');
          return;
        }
        await firebase.firestore().collection('scheduledRecommendations').add({
          type: "개별",
          userId,
          numbers: selectedNumbersArr.join('\n'),
          round,
          cheerMsg,
          sendAt,
          status: "scheduled",
          createdAt: new Date()
        });
        alert('예약 발송이 등록되었습니다!');
        document.getElementById('sendModal').classList.add('hidden');
        loadSchedules();
        return;
      }

      // 즉시 발송(기존)
      await firebase.firestore().collection('recommendations').add({
        userId,
        numbers: selectedNumbersArr.join('\n'),
        round,
        sentAt: now,
        cheerMsg,
        totalCount: uniqueLines.length
      });
      await firebase.firestore().collection('recommendationLogs').add({
        userId,
        numbers: selectedNumbersArr.join('\n'),
        round,
        sentAt: now,
        cheerMsg,
        type: '개별'
      });
      let phone = '';
      const userDoc = await firebase.firestore().collection('users').where('userId', '==', userId).get();
      if (!userDoc.empty) {
        phone = userDoc.docs[0].data().phone;
      }
      if (phone) {
        fetch('http://localhost:4000/send-sms', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            to: phone,
            numbers: selectedNumbersArr.join('\n'),
            message: cheerMsg
          })
        })
          .then(r => r.json())
          .then(result => {
            if (result.success) {
              alert('추천번호 30개가 저장되고 문자로 발송되었습니다.');
            } else {
              alert('문자 발송 실패: ' + JSON.stringify(result.error));
            }
          })
          .catch(err => alert('문자 발송 에러: ' + err));
      } else {
        alert('사용자 전화번호를 찾을 수 없습니다. Firestore에 전화번호를 추가해 주세요.');
      }
      document.getElementById('sendModal').classList.add('hidden');
      loadRecommendationLogs && loadRecommendationLogs();
    };

    // ---- 일괄 발송 모달 열기 ----


    // ---- 일괄 발송 (즉시/예약) ----
 

    // ---- 예약 발송 현황(관리자) ----
    async function loadSchedules() {
      const div = document.getElementById('scheduleList');
      div.innerHTML = '불러오는 중...';
      const snap = await firebase.firestore().collection('scheduledRecommendations').orderBy('sendAt').get();
      if (snap.empty) {
        div.innerHTML = '<div class="text-gray-400 py-6 text-center">예약 내역이 없습니다.</div>';
        return;
      }
      let html = `<table class="table w-full text-center"><thead>
        <tr>
          <th class="py-2 px-3">타입</th>
          <th class="py-2 px-3">대상</th>
          <th class="py-2 px-3">회차</th>
          <th class="py-2 px-3">예약일시</th>
          <th class="py-2 px-3">상태</th>
          <th class="py-2 px-3">관리</th>
        </tr>
      </thead><tbody>`;
      snap.forEach(doc => {
        const data = doc.data();
        html += `<tr>
          <td>${data.type}</td>
          <td>${data.type === '개별' ? data.userId : '전체'}</td>
          <td>${data.round}</td>
          <td>${data.sendAt.toDate ? data.sendAt.toDate().toLocaleString() : ''}</td>
          <td>${data.status}</td>
          <td>
            ${data.status === "scheduled" ? `<button onclick="cancelSchedule('${doc.id}')">취소</button>` : ''}
          </td>
        </tr>`;
      });
      html += '</tbody></table>';
      div.innerHTML = html;
    }
    window.cancelSchedule = async function(id) {
      if (!confirm('예약을 취소하시겠습니까?')) return;
      await firebase.firestore().collection('scheduledRecommendations').doc(id).update({status: "canceled"});
      loadSchedules();
    };

    // ---- 회원 이력 모달 ----
    function openHistoryModal(userId) {
      const modal = document.getElementById('historyModal');
      const contentDiv = document.getElementById('historyContent');
      contentDiv.innerHTML = '<div class="text-gray-500 text-center py-4">로딩 중...</div>';
      modal.classList.remove('hidden');
      firebase.firestore().collection('recommendations')
        .where('userId', '==', userId)
        .orderBy('sentAt', 'desc')
        .get()
        .then(snapshot => {
          if (snapshot.empty) {
            contentDiv.innerHTML = '<div class="text-gray-500 text-center py-4">추천번호 이력이 없습니다.</div>';
            return;
          }
          let html = `<table class="w-full text-center border mt-2">
            <thead>
              <tr class="bg-gray-50">
                <th class="py-1 px-2">회차</th>
                <th class="py-1 px-2">추천번호(최대 30줄)</th>
                <th class="py-1 px-2">발송일</th>
              </tr>
            </thead>
            <tbody>`;
          snapshot.forEach(doc => {
            const data = doc.data();
            const dt = data.sentAt && data.sentAt.toDate ? data.sentAt.toDate().toLocaleDateString() : '';
            html += `<tr>
              <td class="py-1 px-2 font-bold">${data.round || '-'}</td>
              <td class="py-1 px-2 text-xs whitespace-pre-line">${data.numbers}</td>
              <td class="py-1 px-2">${dt}</td>
            </tr>`;
          });
          html += '</tbody></table>';
          contentDiv.innerHTML = html;
        });
    }
    document.getElementById('closeHistoryModal').onclick = () => {
      document.getElementById('historyModal').classList.add('hidden');
    };

    // ---- QnA 전체 목록 불러오기 ----
    function loadQnaList() {
      const div = document.getElementById('qnaList');
      div.innerHTML = '';
      firebase.firestore().collection('qna').orderBy('createdAt', 'desc').get().then(snapshot => {
        if (snapshot.empty) {
          div.innerHTML = '<p class="py-6 text-accent text-center">Q&A가 없습니다.</p>';
          return;
        }
        div.innerHTML = `<table class="table w-full text-center text-gray-700">
          <thead>
            <tr>
              <th class="py-2 px-3">제목</th>
              <th class="py-2 px-3">이메일</th>
              <th class="py-2 px-3">작성일</th>
              <th class="py-2 px-3">답변상태</th>
              <th class="py-2 px-3">관리</th>
            </tr>
          </thead>
          <tbody>
            ${snapshot.docs.map(doc => {
              const q = doc.data();
              const date = q.createdAt && q.createdAt.toDate ? q.createdAt.toDate().toLocaleDateString() : '';
              return `
                <tr>
                  <td class="py-2 px-3 text-left">${q.title}</td>
                  <td class="py-2 px-3">${q.email || ''}</td>
                  <td class="py-2 px-3">${date}</td>
                  <td class="py-2 px-3">
                    ${q.answer && q.answer.trim() ? '<span class="status-paid">완료</span>' : '<span class="status-expired">대기</span>'}
                  </td>
                  <td class="py-2 px-3">
                    <button class="answerBtn bg-accent text-white rounded px-3 py-1" 
                      data-id="${doc.id}" 
                      data-title="${q.title}" 
                      data-content="${q.content}" 
                      data-answer="${q.answer || ''}">
                      ${q.answer && q.answer.trim() ? '수정' : '답변'}
                    </button>
                  </td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>`;
        document.querySelectorAll('.answerBtn').forEach(btn => {
          btn.onclick = function() {
            openAnswerModal(
              this.getAttribute('data-id'),
              this.getAttribute('data-title'),
              this.getAttribute('data-content'),
              this.getAttribute('data-answer')
            );
          };
        });
      });
    }

    // ---- QnA 답변 모달 ----
    function openAnswerModal(id, title, content, answer) {
      document.getElementById('answerModal').classList.remove('hidden');
      document.getElementById('modalQTitle').textContent = title;
      document.getElementById('modalQContent').textContent = content;
      document.getElementById('answerInput').value = answer || '';
      document.getElementById('answerForm').onsubmit = function(e) {
        e.preventDefault();
        const val = document.getElementById('answerInput').value.trim();
        firebase.firestore().collection('qna').doc(id).update({ answer: val })
          .then(() => {
            document.getElementById('answerModal').classList.add('hidden');
            loadQnaList();
          });
      };
    }
    document.getElementById('closeAnswerModal').onclick = () => {
      document.getElementById('answerModal').classList.add('hidden');
    };


async function loadApproveList() {
  const div = document.getElementById('approveList');
  div.innerHTML = '불러오는 중...';
  // bankTransfers 모든 데이터 가져옴 (전화번호/이름/상품)
  const snap = await firebase.firestore().collection('bankTransfers').orderBy('requestedAt', 'desc').get();
  if (snap.empty) {
    div.innerHTML = '<div class="py-8 text-gray-400 text-center">승인 대기 내역이 없습니다.</div>';
    return;
  }

  let html = `<table class="table w-full text-center">
    <thead>
      <tr>
        <th class="py-2 px-3">이름</th>
        <th class="py-2 px-3">전화번호</th>
        <th class="py-2 px-3">상품</th>
        <th class="py-2 px-3">금액</th>
        <th class="py-2 px-3">신청일</th>
        <th class="py-2 px-3">회원상태</th>
        <th class="py-2 px-3">관리</th>
      </tr>
    </thead><tbody>`;

  // 비동기 for문(모든 입금자마다 users에서 membership 상태 체크)
  for (const doc of snap.docs) {
    const data = doc.data();
    const phone = data.phone || '';
    const name = data.payer || '';
    const product = data.product || '';
    const amount = data.amount || '';
    const date = data.requestedAt && data.requestedAt.toDate ? data.requestedAt.toDate().toLocaleString() : '';
    // 유저 membership 조회
    let membership = '-';
    let userDoc = await firebase.firestore().collection('users').where('phone', '==', phone).limit(1).get();
    let userId = '';
    if (!userDoc.empty) {
      const u = userDoc.docs[0].data();
      membership = u.membership === true ? '승인완료' : '승인대기';
      userId = userDoc.docs[0].id;
    }
    html += `<tr>
      <td>${name}</td>
      <td>${phone}</td>
      <td>${product}</td>
      <td>${amount}</td>
      <td>${date}</td>
      <td>${membership}</td>
      <td>
        ${
          membership === '승인대기' && userId
            ? `<button class="approveBtn px-3 py-1 bg-primary text-white rounded" data-uid="${userId}" data-phone="${phone}">승인</button>`
            : ''
        }
      </td>
    </tr>`;
  }
  html += '</tbody></table>';
  div.innerHTML = html;

// 승인 버튼 클릭 시
// 승인 버튼 클릭 시 (수정 코드)
document.querySelectorAll('.approveBtn').forEach(btn => {
  btn.onclick = async function() {
    const uid = this.getAttribute('data-uid');
    const phone = this.getAttribute('data-phone');
    if (!uid || !phone) return alert('유저 정보를 찾을 수 없습니다.');
    if (!confirm('해당 유저를 승인 처리하시겠습니까?')) return;

    this.textContent = '승인중...';
    this.disabled = true;
    this.classList.add('opacity-50');

    let approveError = false;
    try {
      // bankTransfers에서 phone으로 최신 결제건 조회
      let plan = 'basic';
      const bankSnap = await firebase.firestore()
        .collection('bankTransfers')
        .where('phone', '==', phone)
        .orderBy('requestedAt', 'desc')
        .limit(1)
        .get();

      if (!bankSnap.empty) {
        const data = bankSnap.docs[0].data();
        if (data.product) plan = data.product.toLowerCase();
      }

      // users.plan 항상 최신으로 덮어쓰기
      await firebase.firestore().collection('users').doc(uid).update({
        membership: true,
        plan: plan
      });

      // bankTransfers 승인 처리
      if (!bankSnap.empty) {
        const bankId = bankSnap.docs[0].id;
        await firebase.firestore().collection('bankTransfers').doc(bankId)
          .update({ approveAt: firebase.firestore.Timestamp.fromDate(new Date()) });
      }
    } catch (e) {
      approveError = true;
    }

    await loadApproveList();
    loadUsers && loadUsers();

    if (approveError) {
      alert('승인 처리 중 일부 오류가 있었으나, 회원은 승인처리 되었습니다.');
    }
  };
});

}


    // ---- 당첨번호 및 회원별 성적 ----
    async function loadLatestWinningNumber() {
      const div = document.getElementById('winningLatest');
      div.textContent = '불러오는 중...';
      const round = Number(getCurrentRound()) - 1; // ★ 여기만 수정!
      const q = await firebase.firestore()
        .collection('winningNumbers')
        .where('round', '==', round)
        .orderBy('createdAt', 'desc')
        .limit(1)
        .get();
      if (q.empty) {
        div.textContent = `이번주(${round}회차) 당첨번호가 입력되지 않았습니다.`;
      } else {
        const data = q.docs[0].data();
        div.innerHTML = `<b>${data.round}회차</b> | ${data.numbers.join(', ')}${data.bonus ? ' + 보너스: ' + data.bonus : ''}`;
        data.numbers.forEach((num, idx) => {
          document.getElementById('win' + (idx+1)).value = num;
        });
        if (data.bonus) document.getElementById('winBonus').value = data.bonus;
      }
    }
    async function loadUserResults() {
      const div = document.getElementById('userResults');
      div.innerHTML = '<div class="text-gray-500">불러오는 중...</div>';
      const round = Number(getCurrentRound())-1;
      const [usersSnap, winSnap, recsSnap] = await Promise.all([
        firebase.firestore().collection('users').get(),
        firebase.firestore().collection('winningNumbers').where('round', '==', round).orderBy('createdAt', 'desc').limit(1).get(),
        firebase.firestore().collection('recommendations').where('round', '==', round).get(),
      ]);
      if (usersSnap.empty) {
        div.innerHTML = '<div class="text-gray-500">가입한 회원이 없습니다.</div>';
        return;
      }
      if (winSnap.empty) {
        div.innerHTML = '<div class="text-gray-500">이번 회차 당첨번호가 없습니다.</div>';
        return;
      }
      const winData = winSnap.docs[0].data();
      const winNums = winData.numbers.map(Number);
      const bonus = Number(winData.bonus);
      const recsMap = {};
      recsSnap.forEach(doc => {
        const rec = doc.data();
        const key = (rec.userId || '').trim();
        const nums = (rec.numbers || '').trim();
        if (!recsMap[key]) recsMap[key] = [];
        nums.split('\n').forEach(oneSet => {
          if (oneSet) recsMap[key].push(oneSet);
        });
      });

      let html = `
        <table class="table w-full text-center mt-4">
<thead>
  <tr>
    <th class="py-2 px-3">이메일</th>
    <th class="py-2 px-3">닉네임</th>
    <th class="py-2 px-3">가입일</th>
    <th class="py-2 px-3">회원구분</th>
    <th class="py-2 px-3">번호 발송</th>
  </tr>
</thead>

          <tbody>
      `;
      usersSnap.forEach(doc => {
        const user = doc.data();
        const userId = user.userId;
        const name = user.name || '-';
        const numsArr = recsMap[userId];
        if (!numsArr || numsArr.length === 0) {
          html += `<tr>
            <td class="py-1 px-2">${userId}</td>
            <td class="py-1 px-2">${name}</td>
            <td class="py-1 px-2 text-gray-400">-</td>
            <td class="py-1 px-2 text-gray-400">-</td>
            <td class="py-1 px-2 text-gray-400">-</td>
            <td class="py-1 px-2 text-gray-400">-</td>
          </tr>`;
          return;
        }

        let best = {
          matchCount: 0,
          match: [],
          bonusMatch: false,
          rankValue: 10,
          rank: "-",
          nums: ""
        };
        numsArr.forEach(numsStr => {
          const userNums = numsStr.split(',').map(s => Number(s.trim())).filter(n => !isNaN(n));
          const match = userNums.filter(n => winNums.includes(n));
          const bonusMatch = bonus && userNums.includes(bonus);
          const rank = getLottoRank(match.length, bonusMatch);
          const rankValue = getRankValue(match.length, bonusMatch);
          if (rankValue < best.rankValue) {
            best = {
              matchCount: match.length,
              match,
              bonusMatch,
              rankValue,
              rank,
              nums: userNums.join(', ')
            };
          }
        });

        html += `<tr>
          <td class="py-1 px-2">${userId}</td>
          <td class="py-1 px-2">${name}</td>
          <td class="py-1 px-2">${best.nums}</td>
          <td class="py-1 px-2 font-bold">${best.matchCount}개 (${best.match.join(', ')})</td>
          <td class="py-1 px-2 font-bold">${best.rank}</td>
        </tr>`;
      });

      html += '</tbody></table>';
      div.innerHTML = html;
    }
    function getRankValue(matchCount, bonusMatch) {
      if (matchCount === 6) return 1;
      if (matchCount === 5 && bonusMatch) return 2;
      if (matchCount === 5) return 3;
      if (matchCount === 4) return 4;
      if (matchCount === 3) return 5;
      return 10;
    }
    function getLottoRank(matchCount, bonusMatch) {
      if (matchCount === 6) return "1등";
      if (matchCount === 5 && bonusMatch) return "2등";
      if (matchCount === 5) return "3등";
      if (matchCount === 4) return "4등";
      if (matchCount === 3) return "5등";
      return "-";
    }

    // ---- 당첨번호 저장 ----
    document.getElementById('winningForm').onsubmit = async function(e) {
      e.preventDefault();
      const round = getCurrentRound() - 1;
      const numbers = [
        Number(document.getElementById('win1').value),
        Number(document.getElementById('win2').value),
        Number(document.getElementById('win3').value),
        Number(document.getElementById('win4').value),
        Number(document.getElementById('win5').value),
        Number(document.getElementById('win6').value)
      ];
      const bonus = Number(document.getElementById('winBonus').value) || null;

      if (new Set(numbers).size !== 6 || numbers.some(n => n < 1 || n > 45)) {
        alert('1~45 사이의 중복 없는 6개 번호를 입력하세요.');
        return;
      }
      if (bonus && (numbers.includes(bonus) || bonus < 1 || bonus > 45)) {
        alert('보너스 번호는 1~45 사이, 기존 6개와 겹치면 안됩니다.');
        return;
      }

      await firebase.firestore().collection('winningNumbers').add({
        round,
        numbers,
        bonus,
        createdAt: new Date()
      });
      alert('금주 당첨번호가 저장되었습니다.');
      loadLatestWinningNumber();
      loadUserResults();
    };

    // ---- 진입시 데이터 로드 ----
    loadUsers();
    loadLatestWinningNumber();
    loadUserResults();
    loadSchedules();

    // // ---- PW 커버 ----
    // function checkPw() {
    //   const pw = document.getElementById('adminPw').value;
    //   if (pw === '1081') {
    //     document.getElementById('pwCover').style.display = 'none';
    //   } else {
    //     alert('비밀번호가 틀렸습니다.');
    //   }
    // }
  </script>

    <script> //엑셀 다운로드 스크립트
    document.getElementById('downloadResultCSV').onclick = function () {
  // 1. 표 헤더 및 데이터 수집
  const table = document.querySelector('#userResults table');
  if (!table) {
    alert('다운로드할 데이터가 없습니다.');
    return;
  }

  let csv = '';

  // --- 상단에 회차 및 당첨번호 정보 추가
  const roundInfo = document.getElementById('winningLatest').textContent.replace(/\s+/g, ' ').trim();
  csv += `"${roundInfo}"\r\n\r\n`;

  // --- 헤더
  const headers = Array.from(table.querySelectorAll('thead th')).map(th => `"${th.innerText.replace(/\n/g,' ').trim()}"`);
  csv += headers.join(',') + '\r\n';

  // --- 데이터
  const rows = table.querySelectorAll('tbody tr');
  rows.forEach(tr => {
    const cells = Array.from(tr.querySelectorAll('td')).map(td => `"${td.innerText.replace(/\n/g, ' ').trim()}"`);
    csv += cells.join(',') + '\r\n';
  });

  // **BOM 추가!!**
  const bom = '\uFEFF';
  const blob = new Blob([bom + csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = '로또1081_금주성적표.csv';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
};

  </script>

  <script>
    function openSelectedSendModal(selectedUsers) {
  // 모달 요소 표시
  document.getElementById('selectedSendModal').classList.remove('hidden');
  // 선택회원 리스트 표시
  document.getElementById('selectedSendList').textContent = selectedUsers.join(', ');
  // 폼 초기화
  document.getElementById('selectedNumbers').value = '';
  document.getElementById('selectedCustomCheer').value = '';
  document.getElementById('selectedSendResult').textContent = '';
  document.getElementById('selectedSendSchedule').value = '';
  // 대상 userId 배열을 전역 변수 등에 저장 (폼 제출에서 활용)
  window._selectedSendUserIds = selectedUsers;
}

    function loadRecommendationLogs() {
  // 예: Firestore에서 recommendationLogs 데이터를 읽어와서
  // #recommendationLogs 라는 div나 테이블에 출력하는 코드 작성
  // 일단은 아래처럼 임시로 처리 가능:
  console.log('loadRecommendationLogs called (구현 필요)');
}
  </script>

  <script>//선택회원
    document.getElementById('selectedSendBtn').onclick = function () {
  // 체크된 회원(이메일 or userId)
  const checked = Array.from(document.querySelectorAll('.user-checkbox:checked'))
    .map(cb => cb.getAttribute('data-email'))
    .filter(Boolean);

  if (checked.length === 0) {
    alert('발송할 회원을 선택하세요!');
    return;
  }

  // 선택회원 정보 표시 및 모달 오픈
  openSelectedSendModal(checked);
};
document.getElementById('selectedDeleteBtn').onclick = async function () {
  // 체크된 회원(이메일 or userId)
  const checked = Array.from(document.querySelectorAll('.user-checkbox:checked'))
    .map(cb => cb.getAttribute('data-email'))
    .filter(Boolean);

  if (checked.length === 0) {
    alert('멤버십 해지 시킬 회원을 선택하세요!');
    return;
  }

  if (!confirm(`선택한 ${checked.length}명의 회원을 멤버십 해지 처리하시겠습니까? 멤버십 해지 시 회원의 membership이 해제되고, 관련 입금 정보가 삭제됩니다.`)) {
    return;
  }

  let successCount = 0, failList = [];
  for (const userId of checked) {
    try {
      // 1. 회원 정보에서 membership: false로 변경
      const userSnap = await firebase.firestore().collection('users').where('userId', '==', userId).get();
      if (!userSnap.empty) {
        const userDocId = userSnap.docs[0].id;
        await firebase.firestore().collection('users').doc(userDocId).update({ membership: false });
        // 2. bankTransfers 컬렉션에서 해당 회원의 문서(들) 삭제 (phone 기준)
        const phone = userSnap.docs[0].data().phone;
        if (phone) {
          const btSnap = await firebase.firestore().collection('bankTransfers').where('phone', '==', phone).get();
          for (const btDoc of btSnap.docs) {
            await firebase.firestore().collection('bankTransfers').doc(btDoc.id).delete();
          }
        }
        successCount++;
      } else {
        failList.push(userId);
      }
    } catch (e) {
      failList.push(userId);
    }
  }
  alert(`총 ${checked.length}명 중 ${successCount}명 탈퇴 완료${failList.length ? `, 실패: ${failList.join(', ')}` : ''}`);
  loadUsers && loadUsers();
  loadApproveList && loadApproveList();
};

document.getElementById('closeSelectedSendModal').onclick =
document.getElementById('closeSelectedSendModal2').onclick = function() {
  document.getElementById('selectedSendModal').classList.add('hidden');
};


document.getElementById('selectedSendForm').onsubmit = async function(e) {
  e.preventDefault();
  const userIds = window._selectedSendUserIds || [];
  const textareaValue = document.getElementById('selectedNumbers').value.trim();
  const round = getCurrentRound();
  const now = new Date();
  const selectMsg = document.getElementById('selectedCheerSelect').value;
  const customMsg = document.getElementById('selectedCustomCheer').value.trim();
  const cheerMsg = customMsg ? customMsg : selectMsg;
  const sendSchedule = document.getElementById('selectedSendSchedule').value;
  const statusDiv = document.getElementById('selectedSendResult');

  // 조합 파싱
  const lines = textareaValue
    .split('\n')
    .map(line => line.replace(/\s/g, ''))
    .filter(line => !!line && line.split(',').length === 6 && line.split(',').every(n => !isNaN(Number(n)) && Number(n) >= 1 && Number(n) <= 45));
  const uniqueLines = Array.from(new Set(lines));
  if (uniqueLines.length < 20) {
    alert('20개 이상의 6자리 숫자 조합을 한 줄에 1개씩 입력해 주세요.');
    statusDiv.textContent = '';
    return;
  }

  // 예약발송
  if (sendSchedule) {
    let sendAt = new Date(sendSchedule);
    if (sendAt <= new Date()) {
      alert('예약 발송 시각은 현재 시각 이후여야 합니다.');
      return;
    }
    // 선택된 회원 각각에 대해 예약 발송 등록
    for (const userId of userIds) {
      await firebase.firestore().collection('scheduledRecommendations').add({
        type: "개별",
        userId,
        numbers: uniqueLines.slice(0, 30).join('\n'),
        round,
        cheerMsg,
        sendAt,
        status: "scheduled",
        createdAt: new Date()
      });
    }
    alert('선택한 회원에게 예약 발송이 등록되었습니다!');
    document.getElementById('selectedSendModal').classList.add('hidden');
    loadSchedules && loadSchedules();
    return;
  }

  // 즉시 발송
  let sentCount = 0, failList = [];
  for (const userId of userIds) {
    try {
      // Firestore 기록
      await firebase.firestore().collection('recommendations').add({
        userId,
        numbers: uniqueLines.slice(0, 30).join('\n'),
        round,
        sentAt: now,
        cheerMsg,
        totalCount: uniqueLines.length
      });
      await firebase.firestore().collection('recommendationLogs').add({
        userId,
        numbers: uniqueLines.slice(0, 30).join('\n'),
        round,
        sentAt: now,
        cheerMsg,
        type: '선택발송'
      });

      // 전화번호 조회 후 문자 발송
      let phone = '';
      const userDoc = await firebase.firestore().collection('users').where('userId', '==', userId).get();
      if (!userDoc.empty) {
        phone = userDoc.docs[0].data().phone;
      }
      if (phone) {
        const res = await fetch('http://localhost:4000/send-sms', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            to: phone,
            numbers: uniqueLines.slice(0, 30).join('\n'),
            message: cheerMsg
          })
        });
        const result = await res.json();
        if (result.success) sentCount++;
        else failList.push(userId);
      } else {
        failList.push(userId);
      }
    } catch (err) {
      failList.push(userId);
    }
  }

  alert(`선택한 회원 ${userIds.length}명 중 ${sentCount}명 발송 성공${failList.length ? `, 실패: ${failList.join(', ')}` : ''}`);
  document.getElementById('selectedSendModal').classList.add('hidden');
  loadUsers && loadUsers();
};

  </script>
</body>
</html>